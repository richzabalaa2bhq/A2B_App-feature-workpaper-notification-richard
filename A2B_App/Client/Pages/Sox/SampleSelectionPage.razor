@page "/sampleselectionpage/"
@page "/sampleselectionpage/{version}/{rcmItemId}/{testingPhase}"
@*parameter {version} can pass in the page*@


@using BlazorDateRangePicker
@using System
@using System.IO
@using Newtonsoft.Json
@using System.Net.Http
@using System.Globalization
@using BlazorInputFile
@using System.Text;
@using A2B_App.Client.Component.SampleSelection;
@using A2B_App.Shared.Sox
@using System.Linq;
@using A2B_App.Client.Services
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.WebAssembly.Authentication
@using A2B_App.Shared.Utilities
@using A2B_App.Client.Component.Utilities
@inject IJSRuntime JSRuntime
@inject IToastService toastService
@inject NavigationManager NavigationManager
@inject Task<ClientSettings> _getSettings
@attribute [Authorize(Roles = "Admin, IT, Accounting")]
@inject HttpClient Http

<h1>@title</h1>



@if (sampleSelection == null)
{
    <p><em>Loading...</em></p>
}
else
{

    <div class="row">
        <div class="col-6"><p class="float-left">Fill in information to auto generate data</p></div>
        <div class="col-6"><button class="btn btn-primary float-right @(rcmItemId == "0" ? "" : "hidden-field")" @onclick="NewData">New Sample Selection</button></div>
    </div>

    <div class="border-top my-3"></div>

    <form>
        @*bind model to form elements*@
        <EditForm Model="sampleSelection">

            <div class="row">

                @*field client name selection*@
                <div class="col">
                    <div class="form-group">
                        <label for="client">Client</label>
                        <select class="form-control" id="client" @onchange="SetCategoryClient" disabled="@(rcmItemId != "0" ? true : false)">
                            @if (ListClient != null)
                            {
                                foreach (var item in ListClient)
                                {
                                    <option value="@item.ClientName">@item.ClientName</option>
                                }
                            }
                        </select>
                    </div>
                </div>

                @*field external auditor*@
                <div class="col">
                    <label for="externalAuditor">External Auditor</label>
                    <input class="form-control" type="text" placeholder="" readonly id="externalAuditor" @bind-value="sampleSelection.ExternalAuditor">
                </div>

                @*field Q4 R3 is required selection*@
                <div class="col">
                    <div class="form-group">
                        <label for="sampleRequired">Q4 (R3) Sample Required?</label>
                        <select class="form-control" id="sampleRequired" @onchange="SetQ4R3Required">
                            @if (ListQ4R3 != null)
                            {
                                foreach (var item in ListQ4R3)
                                {
                                    <option value="@item">@item</option>
                                }
                            }

                        </select>
                    </div>
                </div>

                @*condition if yes required Q4 R3*@
                @if (sampleSelection.Q4R3SampleRequired == "Yes")
                {
                    <div class="col">
                        <div class="form-group">
                            <label for="sampleQ4R3">How many samples to be tested in Q4?</label>
                            <input type="text" class="form-control" id="sampleQ4R3" @bind-value="sampleSelection.CountSampleQ4R3">
                        </div>
                    </div>
                }
                else
                {
                    <div class="col"></div>
                }

            </div>

            <div class="row">

                @*field risk selection*@
                <div class="col">
                    <div class="form-group">
                        <label for="risk">Risk</label>
                        <select class="form-control" id="risk" @onchange="SetRisk" disabled="@(rcmItemId != "0" ? true : false)">
                            @if (ListRisk != null)
                            {
                                foreach (var item in ListRisk)
                                {
                                    <option value="@item">@item</option>
                                }
                            }
                        </select>
                    </div>
                </div>

                @*field frequency selection*@
                <div class="col">
                    <div class="form-group">
                        <label for="frequency">Frequency</label>
                        <select class="form-control" id="frequency" disabled="@(version == "3" || rcmItemId != "0" ? true : false)" @onchange="SetCategoryFrequency">
                            @if (ListFrequency != null)
                            {
                                foreach (var item in ListFrequency)
                                {
                                    <option value="@item.Freq">@item.Freq</option>
                                }
                            }
                        </select>
                    </div>
                </div>

                @*field annual population*@
                <div class="col">
                    <label for="annualPop">Annual Population</label>
                    <input class="form-control" type="text" placeholder="" id="annualPop" readonly @bind-value="sampleSelection.AnnualPopulation">
                </div>

                @*field annual sample size*@
                <div class="col">
                    <label for="annualSamp">Annual Sample Size</label>
                    <input class="form-control" type="text" placeholder="" id="annualSamp" readonly @bind-value="sampleSelection.AnnualSampleSize">
                </div>

            </div>

            @*Load download population template button*@
            <DownloadPopulationTemplate version="@version"></DownloadPopulationTemplate>

            @*file upload field for population*@
            <div class="row @(version == "3" ? "" : "hidden-field")">
                <div class="col form-group">
                    @*<InputFile OnChange="HandleFileSelected" />*@
                    <A2B_App.Client.Component.Rcm.DragDropFile ReturnFiles="@((e) => { HandleFileSelected(e); })" enableRemove="isEnableRemoveFile" title="Upload Population File" fileFormatAccepted="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel"></A2B_App.Client.Component.Rcm.DragDropFile>
                </div>
                <div class="col"></div>
                <div class="col"></div>
                <div class="col"></div>
                <div class="col"></div>
            </div>

            @*transactional and materiality fields*@
            <div class="row @(version == "3" ? "" : "hidden-field")">

                @*field materiality*@
                <div class="col">
                    <div class="form-group">
                        <label for="materialityreq">Is Materiality Required?</label>
                        <select class="form-control" id="materialityreq" @onchange="SetMaterialityValue" disabled="@isDisableMateriality">
                            <option value=""></option>
                            <option value="Yes">Yes</option>
                            <option value="No">No</option>
                        </select>

                    </div>
                </div>

                <div class="col">

                    <div class="form-group @(sampleSelection.IsMateriality == "Yes" && activeMateriality == 1? "" : "hidden-field")">
                        <label for="materialityround1">Materiality to Consider</label>
                        <select class="form-control" id="materialityround1" @onchange="SetSelectedMaterialityToConsider1" disabled="@isDisableMateriality">
                            @if (activeMateriality == 1)
                            {
                                @if (listDropdownPop1 != null && listDropdownPop1.Count > 0)
                                {
                                    <option value=""></option>
                                    foreach (var item in listDropdownPop1)
                                    {
                                        <option value="@item">@item</option>
                                    }
                                }
                            }
                        </select>
                    </div>

                    <div class="form-group @(sampleSelection.IsMateriality == "Yes" && activeMateriality == 2 ? "" : "hidden-field")">
                        <label for="materialityround2">Materiality to Consider</label>
                        <select class="form-control" id="materialityround2" @onchange="SetSelectedMaterialityToConsider2" disabled="@isDisableMateriality">
                            @if (activeMateriality == 2)
                            {
                                @if (listDropdownPop2 != null && listDropdownPop2.Count > 0)
                                {
                                    <option value=""></option>
                                    foreach (var item in listDropdownPop2)
                                    {
                                        <option value="@item">@item</option>
                                    }
                                }
                            }
                        </select>
                    </div>

                    <div class="form-group @(sampleSelection.IsMateriality == "Yes" && activeMateriality == 3 ? "" : "hidden-field")">
                        <label for="materialityround3">Materiality to Consider</label>
                        <select class="form-control" id="materialityround3" @onchange="SetSelectedMaterialityToConsider3" disabled="@isDisableMateriality">
                            @if (activeMateriality == 3)
                            {
                                @if (activeMateriality == 3)
                                {
                                    <option value=""></option>
                                    foreach (var item in listDropdownPop3)
                                    {
                                        <option value="@item">@item</option>
                                    }
                                }
                            }
                        </select>
                    </div>

                </div>

                <div class="col"></div>
                <div class="col"></div>
                <div class="col"></div>

            </div>

            @*field materiality display header round 1*@
            <div class="row @(version == "3" && activeMateriality == 1 ? "" : "hidden-field")">

                <div class="col ">
                    <div class="form-group ">
                        <label for="headerDisplay1">Header to Display</label>
                        <select class="form-control" id="headerDisplay1" @onchange="SetSelectedHeader1" disabled="@isDisableMateriality">
                            @if (activeMateriality == 1)
                            {
                                @if (listDropdownPop1 != null && listDropdownPop1.Count > 0)
                                {
                                    <option value=""></option>
                                    foreach (var item in listDropdownPop1)
                                    {
                                        <option value="@item">@item</option>
                                    }
                                }
                            }
                        </select>
                    </div>

                </div>

                <div class="col ">
                    <div class="form-group ">
                        <label for="headerDisplay2">Header to Display</label>
                        <select class="form-control" id="headerDisplay2" @onchange="SetSelectedHeader2" disabled="@isDisableMateriality">
                            @if (activeMateriality == 1)
                            {
                                @if (listDropdownPop1 != null && listDropdownPop1.Count > 0)
                                {
                                    <option value=""></option>
                                    foreach (var item in listDropdownPop1)
                                    {
                                        <option value="@item">@item</option>
                                    }
                                }
                            }
                        </select>
                    </div>

                </div>

                <div class="col ">
                    <div class="form-group ">
                        <label for="headerDisplay3">Header to Display</label>
                        <select class="form-control" id="headerDisplay3" @onchange="SetSelectedHeader3" disabled="@isDisableMateriality">
                            @if (activeMateriality == 1)
                            {
                                @if (listDropdownPop1 != null && listDropdownPop1.Count > 0)
                                {
                                    <option value=""></option>
                                    foreach (var item in listDropdownPop1)
                                    {
                                        <option value="@item">@item</option>
                                    }
                                }
                            }
                        </select>
                    </div>

                </div>

                <div class="col ">
                    <div class="form-group ">
                        <label for="headerDisplay4">Header to Display</label>
                        <select class="form-control" id="headerDisplay4" @onchange="SetSelectedHeader4" disabled="@isDisableMateriality">
                            @if (activeMateriality == 1)
                            {
                                @if (listDropdownPop1 != null && listDropdownPop1.Count > 0)
                                {
                                    <option value=""></option>
                                    foreach (var item in listDropdownPop1)
                                    {
                                        <option value="@item">@item</option>
                                    }
                                }
                            }
                        </select>
                    </div>

                </div>

                <div class="col ">
                    <div class="form-group ">
                        <label for="headerDisplay5">Header to Display</label>
                        <select class="form-control" id="headerDisplay5" @onchange="SetSelectedHeader5" disabled="@isDisableMateriality">
                            @if (activeMateriality == 1)
                            {
                                @if (listDropdownPop1 != null && listDropdownPop1.Count > 0)
                                {
                                    <option value=""></option>
                                    foreach (var item in listDropdownPop1)
                                    {
                                        <option value="@item">@item</option>
                                    }
                                }
                            }
                        </select>
                    </div>

                </div>

            </div>

            @*field materiality display header round 2*@
            <div class="row @(version == "3" && activeMateriality == 2 ? "" : "hidden-field")">

                <div class="col ">
                    <div class="form-group">
                        <label for="headerDisplayR21">Header to Display</label>
                        <select class="form-control" id="headerDisplayR21" @onchange="SetSelectedHeader1" disabled="@isDisableMateriality">
                            @if (activeMateriality == 2)
                            {
                                @if (listDropdownPop2 != null && listDropdownPop2.Count > 0)
                                {
                                    <option value=""></option>
                                    foreach (var item in listDropdownPop2)
                                    {
                                        <option value="@item">@item</option>
                                    }
                                }
                            }
                        </select>
                    </div>

                </div>

                <div class="col ">
                    <div class="form-group">
                        <label for="headerDisplayR22">Header to Display</label>
                        <select class="form-control" id="headerDisplayR22" @onchange="SetSelectedHeader2" disabled="@isDisableMateriality">
                            @if (activeMateriality == 2)
                            {
                                @if (listDropdownPop2 != null && listDropdownPop2.Count > 0)
                                {
                                    <option value=""></option>
                                    foreach (var item in listDropdownPop2)
                                    {
                                        <option value="@item">@item</option>
                                    }
                                }
                            }
                        </select>
                    </div>

                </div>

                <div class="col ">
                    <div class="form-group">
                        <label for="headerDisplayR23">Header to Display</label>
                        <select class="form-control" id="headerDisplayR23" @onchange="SetSelectedHeader3" disabled="@isDisableMateriality">
                            @if (activeMateriality == 2)
                            {
                                @if (listDropdownPop2 != null && listDropdownPop2.Count > 0)
                                {
                                    <option value=""></option>
                                    foreach (var item in listDropdownPop2)
                                    {
                                        <option value="@item">@item</option>
                                    }
                                }
                            }
                        </select>
                    </div>

                </div>

                <div class="col ">
                    <div class="form-group ">
                        <label for="headerDisplayR24">Header to Display</label>
                        <select class="form-control" id="headerDisplayR24" @onchange="SetSelectedHeader4" disabled="@isDisableMateriality">
                            @if (activeMateriality == 2)
                            {
                                @if (listDropdownPop2 != null && listDropdownPop2.Count > 0)
                                {
                                    <option value=""></option>
                                    foreach (var item in listDropdownPop2)
                                    {
                                        <option value="@item">@item</option>
                                    }
                                }
                            }
                        </select>
                    </div>

                </div>

                <div class="col ">
                    <div class="form-group ">
                        <label for="headerDisplayR25">Header to Display</label>
                        <select class="form-control" id="headerDisplayR25" @onchange="SetSelectedHeader5" disabled="@isDisableMateriality">
                            @if (activeMateriality == 2)
                            {
                                @if (listDropdownPop2 != null && listDropdownPop2.Count > 0)
                                {
                                    <option value=""></option>
                                    foreach (var item in listDropdownPop2)
                                    {
                                        <option value="@item">@item</option>
                                    }
                                }
                            }
                        </select>
                    </div>

                </div>


            </div>

            @*field materiality display header round 3*@
            <div class="row @(version == "3" && activeMateriality == 3 ? "" : "hidden-field")">

                <div class="col ">
                    <div class="form-group ">
                        <label for="headerDisplayR31">Header to Display</label>
                        <select class="form-control" id="headerDisplayR31" @onchange="SetSelectedHeader1" disabled="@isDisableMateriality">
                            @if (activeMateriality == 3)
                            {
                                @if (listDropdownPop3 != null && listDropdownPop3.Count > 0)
                                {
                                    <option value=""></option>
                                    foreach (var item in listDropdownPop3)
                                    {
                                        <option value="@item">@item</option>
                                    }
                                }
                            }
                        </select>
                    </div>

                </div>

                <div class="col ">
                    <div class="form-group ">
                        <label for="headerDisplayR32">Header to Display</label>
                        <select class="form-control" id="headerDisplayR32" @onchange="SetSelectedHeader2" disabled="@isDisableMateriality">
                            @if (activeMateriality == 3)
                            {
                                @if (listDropdownPop3 != null && listDropdownPop3.Count > 0)
                                {
                                    <option value=""></option>
                                    foreach (var item in listDropdownPop3)
                                    {
                                        <option value="@item">@item</option>
                                    }
                                }
                            }
                        </select>
                    </div>

                </div>

                <div class="col ">
                    <div class="form-group ">
                        <label for="headerDisplayR33">Header to Display</label>
                        <select class="form-control" id="headerDisplayR33" @onchange="SetSelectedHeader3" disabled="@isDisableMateriality">
                            @if (activeMateriality == 3)
                            {
                                @if (listDropdownPop3 != null && listDropdownPop3.Count > 0)
                                {
                                    <option value=""></option>
                                    foreach (var item in listDropdownPop3)
                                    {
                                        <option value="@item">@item</option>
                                    }
                                }
                            }
                        </select>
                    </div>

                </div>

                <div class="col ">
                    <div class="form-group ">
                        <label for="headerDisplayR34">Header to Display</label>
                        <select class="form-control" id="headerDisplayR34" @onchange="SetSelectedHeader4" disabled="@isDisableMateriality">
                            @if (activeMateriality == 3)
                            {
                                @if (listDropdownPop3 != null && listDropdownPop3.Count > 0)
                                {
                                    <option value=""></option>
                                    foreach (var item in listDropdownPop3)
                                    {
                                        <option value="@item">@item</option>
                                    }
                                }
                            }
                        </select>
                    </div>

                </div>

                <div class="col ">
                    <div class="form-group ">
                        <label for="headerDisplayR35">Header to Display</label>
                        <select class="form-control" id="headerDisplayR35" @onchange="SetSelectedHeader5" disabled="@isDisableMateriality">
                            @if (activeMateriality == 3)
                            {
                                @if (listDropdownPop3 != null && listDropdownPop3.Count > 0)
                                {
                                    <option value=""></option>
                                    foreach (var item in listDropdownPop3)
                                    {
                                        <option value="@item">@item</option>
                                    }
                                }
                            }
                        </select>
                    </div>

                </div>

            </div>

            @*Walkthrough sample tested*@
            <div class="row @(version == "3" ? "" : "hidden-field")">

                @*field materiality*@
                <div class="col">
                    <div class="form-group">
                        <label for="iswtsampletested">Is walkthrough sample tested?</label>
                        <select class="form-control" id="iswtsampletested" @onchange="SetWtSampleTestedValue">
                            <option value=""></option>
                            <option value="Yes">Yes</option>
                            <option value="No">No</option>
                        </select>
                    </div>
                </div>

                <div class="col">
                    <div class="form-group @(sampleSelection.IsWTSampleTested == "Yes" ? "" : "hidden-field")">
                        <label for="wtSampleTested">How many walkthrough sample tested?</label>
                        <input class="form-control" type="number" placeholder="" id="wtSampleTested" @bind-value="sampleSelection.WTSampleTested">
                    </div>
                </div>
                <div class="col"></div>
                <div class="col"></div>
                <div class="col"></div>

            </div>


            @*date selection*@
            <br />
            <div class="row ">
                <div class="col">
                    <h6>Population Date Range</h6>
                </div>
            </div>

            <div class="row">

                <div class="col">
                    <div class="form-group">
                        <label for="round1Range">Round 1 </label>
                        @*<DateRangePicker OnRangeSelect="OnRangeSelect1" @bind-StartDate="StartDate1" @bind-EndDate="EndDate1" id="round1range" class="form-control bg-white" readonly />*@
                        <DateSelection OnDateChanged="@((e)=> { GetDate(e, 1); })" isDateRange="@isSingleDateRange"></DateSelection>
                    </div>
                </div>

                @*field round 2 date range selection*@
                <div class="col">
                    <div class="form-group">
                        <label for="round2Range">Round 2 </label>
                        @*<DateRangePicker OnRangeSelect="OnRangeSelect2" @bind-StartDate="StartDate2" @bind-EndDate="EndDate2" id="round2Range" class="form-control bg-white" readonly />*@
                        <DateSelection OnDateChanged="@((e)=> { GetDate(e, 2); })" isDateRange="@isSingleDateRange"></DateSelection>
                    </div>
                </div>

                @*field round 3 date range selection*@
                <div class="col">
                    <div class="form-group">
                        <label for="round3Range">Round 3 </label>
                        @*<DateRangePicker OnRangeSelect="OnRangeSelect3" @bind-StartDate="StartDate3" @bind-EndDate="EndDate3" id="round3Range" class="form-control bg-white" readonly />*@
                        <DateSelection OnDateChanged="@((e)=> { GetDate(e, 3); })" isDateRange="@isSingleDateRange"></DateSelection>
                    </div>
                </div>

                <div class="col">
                    <div class="form-group @(version == "3" ? "" : "hidden-field")">
                        <label for="totalPeriodDays">Total Days Period</label>
                        <input class="form-control" type="text" placeholder="" id="totalPeriodDays" readonly @bind-value="sampleSelection.DaysPeriodRoundTot">
                    </div>
                </div>

            </div>

            <br />

            @*Load test round compute table*@
            <TestRoundComputeTable sampleSelection="sampleSelection"></TestRoundComputeTable>

            <div class="row">
                <div class="col-6">
                    <div class="form-group">
                        <button class="btn btn-success @(isGenerated ? "" : "hidden-field")" @onclick="SaveData">Save</button>
                        @*<button class="btn btn-primary @(fileName != "" ? "" : "hidden-field")" @onclick="DownloadExcelFile">Download Excel File</button>*@
                        <a class="btn btn-primary has-text-white @(fileName != "" ? "" : "hidden-field")" target="_top" download="@fileName" href="@DownloadExcelFile2(fileName)">Download Excel File</a>
                        @if (rcmItemId != "0")
                        {
                            <button class="btn btn-primary @(sampleSelection.PodioItemId > 0 ? "" : "hidden-field")" @onclick="BackToQuestionnaire">Done</button>
                        }
                    </div>
                </div>
            </div>


            @* test field to display custom output*@
            <p>@randomValue</p>


            @*Load Test Round Result Table*@
            <TestRoundTable sampleSelection="@sampleSelection"
                            version="@version"
                            roundSelected="@roundSelected"
                            ReturnRegenData="ReturnRegenData">

            </TestRoundTable>

        </EditForm>

    </form>

}


@code {

    //toogle version 1 and version 2 for daily/weekly/monthly, version 3 for transactional and materiality
    [Parameter] public string version { get; set; }
    [Parameter] public string rcmItemId { get; set; }
    [Parameter] public string testingPhase { get; set; }

    public string title { get; set; }
    SampleSelection sampleSelection = new SampleSelection();
    Rcm rcm;
    SampleSelectionService SelectionService;
    RcmService RcmService;
    ClientSettings settings;
    List<ClientSs> ListClient;
    List<Frequency> ListFrequency;
    List<string> ListRisk, ListQ4R3;
    bool isSingleDateRange { get; set; } = false;

    //list sample size
    List<SampleSize> listSampleSize = new List<SampleSize>();

    //list dropdown
    List<DropDown> listDropDown = new List<DropDown>();

    //list population for transactional and materiality
    //private List<Population> listPopulation1, listPopulation2, listPopulation3;
    List<List<string>> listPopulation1, listPopulation2, listPopulation3;
    List<List<string>> listPopulationContent1, listPopulationContent2, listPopulationContent3;
    List<string> listDropdownPop1, listDropdownPop2, listDropdownPop3;
    //List<StringIndex> listUnique1, listUnique2, listUnique3;

    int[] indexConsiderMat = new int[] { -1, -1, -1 };
    int[] indexSelectedHeaderR1 = new int[] { -1, -1, -1, -1, -1 };
    int[] indexSelectedHeaderR2 = new int[] { -1, -1, -1, -1, -1 };
    int[] indexSelectedHeaderR3 = new int[] { -1, -1, -1, -1, -1 };

    //addtional string for custom value and excel variables
    string randomValue = string.Empty;
    string fileName = string.Empty;

    //boolean toggle for round test generation, set to false if generated successfully
    bool isGenerated, isDisableMateriality, isEnableRemoveFile;

    int roundSelected, activeMateriality;

    //Page initialization
    protected override async Task OnInitializedAsync()
    {
        settings = await _getSettings;
        RcmService = new RcmService(settings);
        SelectionService = new SampleSelectionService(settings);
        //set isgenerated toggle to false
        isGenerated = false;
        isDisableMateriality = true;
        isEnableRemoveFile = false;

        SetTitle();

        //get samplesize value(s) and save in list
        listSampleSize = await SelectionService.SetSampleSizeAsync(Http);

        //get dropdown value(s) and save in list
        listDropDown = await SelectionService.SetDropDownAsync(Http);

        sampleSelection.IsMateriality = string.Empty;

        ////initialize test round
        sampleSelection.ListTestRound = new List<TestRound>();

        //////get client and save in list
        //sampleSelection.ListClient = await SelectionService.SetClient();

        //////get frequency and save in list
        //sampleSelection.ListFrequency = await SelectionService.SetFrequency();

        //////get risk and save in list
        //sampleSelection.ListRisk = await SelectionService.SetRisk();

        ////get Q4R3 and save in list (Yes or No)
        //sampleSelection.ListQ4R3 = await SelectionService.SetQ4R3();

        ////get client and save in list
        ListClient = await SelectionService.SetClientAsync(Http);

        ////get frequency and save in list
        ListFrequency = await SelectionService.SetFrequencyAsync(Http);

        ////get risk and save in list
        ListRisk = await SelectionService.SetRiskAsync(Http);

        //get Q4R3 and save in list (Yes or No)
        ListQ4R3 = await SelectionService.SetQ4R3Async(Http);

        //listPopulation1 = new List<Population>();
        //listPopulation2 = new List<Population>();
        //listPopulation3 = new List<Population>();

        listPopulation1 = new List<List<string>>();
        listPopulation2 = new List<List<string>>();
        listPopulation3 = new List<List<string>>();

        this.StateHasChanged();
    }

    //if parameter changed from version 1,2,3, we reset the data
    protected override async void OnParametersSet()
    {
        NewData();
        ListFrequency = new List<Frequency>();
        ListFrequency = await SelectionService.SetFrequencyAsync(Http);
        //Set title base on version
        SetTitle();

        if (rcmItemId != "0")
        {
            sampleSelection.RcmPodioItemId = int.Parse(rcmItemId);
            rcm = new Rcm();
            try
            {
                rcm = await RcmService.GetRcmByPodioItemId(rcmItemId, Http);
                if (rcm != null)
                {
                    sampleSelection.ClientName = rcm.ClientName;
                    sampleSelection.Risk = rcm.RiskLvl;
                    sampleSelection.Frequency = rcm.ControlFrequency;

                    await JSRuntime.InvokeAsync<object>($"SetClient", sampleSelection.ClientName);
                    await JSRuntime.InvokeAsync<object>($"SetRisk", sampleSelection.Risk);
                    await JSRuntime.InvokeAsync<object>($"SetFrequency", sampleSelection.Frequency);

                    ChangeEventArgs clientEventArgs = new ChangeEventArgs();
                    clientEventArgs.Value = sampleSelection.ClientName;
                    SetCategoryClient(clientEventArgs);

                    ChangeEventArgs riskEventArgs = new ChangeEventArgs();
                    riskEventArgs.Value = sampleSelection.Risk;
                    SetRisk(riskEventArgs);

                    ChangeEventArgs frequencyEventArgs = new ChangeEventArgs();
                    frequencyEventArgs.Value = sampleSelection.Frequency;
                    SetCategoryFrequency(frequencyEventArgs);



                }
            }
            catch (Exception ex)
            {
                System.Diagnostics.Debug.WriteLine($"Error: {ex}");
                //throw;
            }

            this.StateHasChanged();

        }


    }

    private void SetActiveMateriality()
    {
        if (sampleSelection.IsMateriality == "Yes" || sampleSelection.IsMateriality == "No")
        {
            if (StartDate1 == null && StartDate2 == null && StartDate3 == null && listPopulationContent1 != null && listPopulationContent1.Count > 0)
            {
                activeMateriality = 1;
            }
            else if (StartDate1 == null && StartDate2 == null && StartDate3 == null && listPopulationContent2 != null && listPopulationContent2.Count > 0)
            {
                activeMateriality = 2;
            }
            else if (StartDate1 == null && StartDate2 == null && StartDate3 == null && listPopulationContent3 != null && listPopulationContent3.Count > 0)
            {
                activeMateriality = 3;
            }
            else if (StartDate1 != null && StartDate2 == null && StartDate3 == null && listPopulationContent2 != null && listPopulationContent2.Count > 0)
            {
                activeMateriality = 2;
            }
            else if (StartDate1 != null && StartDate2 != null && StartDate3 == null && listPopulationContent3 != null && listPopulationContent3.Count > 0)
            {
                activeMateriality = 3;
            }
            else if (StartDate1 == null && StartDate2 != null && StartDate3 == null && listPopulationContent3 != null && listPopulationContent3.Count > 0)
            {
                activeMateriality = 3;
            }
            else
            {
                activeMateriality = 0;
            }
        }
        System.Diagnostics.Debug.WriteLine($"Active Materiality: {activeMateriality}");
    }

    private void SetTitle()
    {
        switch (version)
        {
            case "1":
                title = "Sample Selection - Full Year";
                break;
            case "2":
                title = "Sample Selection - Partial Year";
                break;
            case "3":
                title = "Sample Selection Transactional and Materiality";
                break;
        }
        this.StateHasChanged();
    }

    //handles selected client field change
    private void SetCategoryClient(ChangeEventArgs e)
    {

        if (e.Value.ToString() != string.Empty)
        {
            List<ClientSs> selectedClient = new List<ClientSs>();
            selectedClient = ListClient.Where(x => x.ClientName == e.Value.ToString()).ToList();
            if (selectedClient != null)
            {
                foreach (var item in selectedClient)
                {
                    sampleSelection.ClientName = item.ClientName;
                    sampleSelection.ExternalAuditor = item.ExternalAuditor;
                    sampleSelection.ClientId = item.ItemId.Value;
                    ComputeRound(false, 0);
                }

            }
        }

    }

    //handles selected Q4 R3 required field change
    private void SetQ4R3Required(ChangeEventArgs e)
    {
        if (e.Value.ToString() != string.Empty)
        {

            sampleSelection.Q4R3SampleRequired = ListQ4R3.Where(x => x == e.Value.ToString()).FirstOrDefault();
            if (sampleSelection.Q4R3SampleRequired == "No")
            {
                sampleSelection.CountSampleQ4R3 = 0;
            }
            ComputeRound(false, 0);
        }
    }

    //handles selected frequency field change
    private void SetCategoryFrequency(ChangeEventArgs e)
    {
        if (e.Value.ToString() != string.Empty)
        {
            if (version != "3")
            {
                List<Frequency> selectedFrequency = new List<Frequency>();
                selectedFrequency = ListFrequency.Where(x => x.Freq == e.Value.ToString()).ToList();
                if (selectedFrequency != null)
                {
                    foreach (var item in selectedFrequency)
                    {
                        sampleSelection.Frequency = item.Freq;
                        sampleSelection.AnnualPopulation = item.IntValue.Value;
                    }
                }

                ComputeRound(false, 0);
            }

        }

    }

    //handles selected risk field change
    private void SetRisk(ChangeEventArgs e)
    {
        if (e.Value.ToString() != string.Empty)
        {

            sampleSelection.Risk = ListRisk.Where(x => x == e.Value.ToString()).FirstOrDefault();
            ComputeRound(false, 0);
        }
    }

    //handles selected materiality field change
    private void SetMaterialityValue(ChangeEventArgs e)
    {
        sampleSelection.IsMateriality = e.Value.ToString();
        SetActiveMateriality();
    }

    private void SetWtSampleTestedValue(ChangeEventArgs e)
    {
        sampleSelection.IsWTSampleTested = e.Value.ToString();
        if (sampleSelection.IsWTSampleTested != "Yes")
        {
            sampleSelection.WTSampleTested = 0;
        }
    }



    //handles selected materiality round 1 field change
    private void SetSelectedMaterialityToConsider1(ChangeEventArgs e)
    {
        if (e.Value.ToString() != string.Empty && sampleSelection.IsMateriality == "Yes" && listDropdownPop1 != null)
        {
            sampleSelection.ConsiderMateriality1 = e.Value.ToString();
            indexConsiderMat[0] = listDropdownPop1.FindIndex(x => x.Contains(e.Value.ToString()));
            System.Diagnostics.Debug.WriteLine($"SetSelectedMaterialityToConsider1 indexConsiderMat1: {indexConsiderMat[0]}");
        }
        else
        {
            indexConsiderMat[0] = -1;
            sampleSelection.ConsiderMateriality1 = string.Empty;
        }
    }

    //handles selected materiality round 2 field change
    private void SetSelectedMaterialityToConsider2(ChangeEventArgs e)
    {
        if (e.Value.ToString() != string.Empty && sampleSelection.IsMateriality == "Yes" && listDropdownPop2 != null)
        {
            sampleSelection.ConsiderMateriality2 = e.Value.ToString();
            indexConsiderMat[1] = listDropdownPop2.FindIndex(x => x.Contains(e.Value.ToString()));
            System.Diagnostics.Debug.WriteLine($"SetSelectedMaterialityToConsider2 indexConsiderMat2: {indexConsiderMat[1]}");
        }
        else
        {
            indexConsiderMat[1] = -1;
            sampleSelection.ConsiderMateriality2 = string.Empty;
        }
    }

    //handles selected materiality round 3 field change
    private void SetSelectedMaterialityToConsider3(ChangeEventArgs e)
    {
        if (e.Value.ToString() != string.Empty && sampleSelection.IsMateriality == "Yes" && listDropdownPop3 != null)
        {
            sampleSelection.ConsiderMateriality3 = e.Value.ToString();
            indexConsiderMat[2] = listDropdownPop3.FindIndex(x => x.Contains(e.Value.ToString()));
            System.Diagnostics.Debug.WriteLine($"SetSelectedMaterialityToConsider3 indexConsiderMat3: {indexConsiderMat[2]}");
        }
        else
        {
            indexConsiderMat[2] = -1;
            sampleSelection.ConsiderMateriality3 = string.Empty;
        }
    }

    //handles selected materiality field 1 change
    private void SetSelectedHeader1(ChangeEventArgs e)
    {
        if (e.Value.ToString() != string.Empty)
        {

            if (activeMateriality == 1)
            {
                indexSelectedHeaderR1[0] = listDropdownPop1.FindIndex(x => x.Equals(e.Value.ToString()));
                sampleSelection.DisplayHeaderR11 = e.Value.ToString();
                System.Diagnostics.Debug.WriteLine($"Trigger SetSelectedHeader1 Index: {indexSelectedHeaderR1[0]} - Value: {sampleSelection.DisplayHeaderR11}");
            }
            else
            {
                indexSelectedHeaderR1[0] = -1;
                sampleSelection.DisplayHeaderR11 = string.Empty;

            }

            if (activeMateriality == 2)
            {
                indexSelectedHeaderR2[0] = listDropdownPop2.FindIndex(x => x.Equals(e.Value.ToString()));
                sampleSelection.DisplayHeaderR21 = e.Value.ToString();
                System.Diagnostics.Debug.WriteLine($"Trigger SetSelectedHeader2 Index: {indexSelectedHeaderR2[0]} - Value: {sampleSelection.DisplayHeaderR21}");
            }
            else
            {
                indexSelectedHeaderR2[0] = -1;
                sampleSelection.DisplayHeaderR21 = string.Empty;
            }

            if (activeMateriality == 3)
            {
                indexSelectedHeaderR3[0] = listDropdownPop3.FindIndex(x => x.Equals(e.Value.ToString()));
                sampleSelection.DisplayHeaderR31 = e.Value.ToString();
                System.Diagnostics.Debug.WriteLine($"Trigger SetSelectedHeader3 Index: {indexSelectedHeaderR3[0]} - Value: {sampleSelection.DisplayHeaderR31}");
            }
            else
            {
                indexSelectedHeaderR3[0] = -1;
                sampleSelection.DisplayHeaderR31 = string.Empty;
            }
        }
    }

    //handles selected materiality field 2 change
    private void SetSelectedHeader2(ChangeEventArgs e)
    {
        if (e.Value.ToString() != string.Empty)
        {

            if (activeMateriality == 1)
            {
                indexSelectedHeaderR1[1] = listDropdownPop1.FindIndex(x => x.Equals(e.Value.ToString()));
                sampleSelection.DisplayHeaderR12 = e.Value.ToString();
                System.Diagnostics.Debug.WriteLine($"Trigger SetSelectedHeader1 Index: {indexSelectedHeaderR1[1]} - Value: {sampleSelection.DisplayHeaderR12}");
            }
            else
            {
                indexSelectedHeaderR1[1] = -1;
                sampleSelection.DisplayHeaderR12 = string.Empty;

            }

            if (activeMateriality == 2)
            {
                indexSelectedHeaderR2[1] = listDropdownPop2.FindIndex(x => x.Equals(e.Value.ToString()));
                sampleSelection.DisplayHeaderR22 = e.Value.ToString();
                System.Diagnostics.Debug.WriteLine($"Trigger SetSelectedHeader2 Index: {indexSelectedHeaderR2[1]} - Value: {sampleSelection.DisplayHeaderR22}");
            }
            else
            {
                indexSelectedHeaderR2[1] = -1;
                sampleSelection.DisplayHeaderR22 = string.Empty;
            }

            if (activeMateriality == 3)
            {
                indexSelectedHeaderR3[1] = listDropdownPop3.FindIndex(x => x.Equals(e.Value.ToString()));
                sampleSelection.DisplayHeaderR32 = e.Value.ToString();
                System.Diagnostics.Debug.WriteLine($"Trigger SetSelectedHeader3 Index: {indexSelectedHeaderR3[1]} - Value: {sampleSelection.DisplayHeaderR32}");
            }
            else
            {
                indexSelectedHeaderR3[1] = -1;
                sampleSelection.DisplayHeaderR32 = string.Empty;
            }
        }

    }

    //handles selected materiality field 3 change
    private void SetSelectedHeader3(ChangeEventArgs e)
    {
        if (e.Value.ToString() != string.Empty)
        {

            System.Diagnostics.Debug.WriteLine($"e.value - {e.Value}");

            if (activeMateriality == 1)
            {
                indexSelectedHeaderR1[2] = listDropdownPop1.FindIndex(x => x.Equals(e.Value.ToString()));
                sampleSelection.DisplayHeaderR13 = e.Value.ToString();
                System.Diagnostics.Debug.WriteLine($"Trigger SetSelectedHeader1 Index: {indexSelectedHeaderR1[2]} - Value: {sampleSelection.DisplayHeaderR13}");
            }
            else
            {
                indexSelectedHeaderR1[2] = -1;
                sampleSelection.DisplayHeaderR13 = string.Empty;

            }

            if (activeMateriality == 2)
            {
                indexSelectedHeaderR2[2] = listDropdownPop2.FindIndex(x => x.Equals(e.Value.ToString()));
                sampleSelection.DisplayHeaderR23 = e.Value.ToString();
                System.Diagnostics.Debug.WriteLine($"Trigger SetSelectedHeader2 Index: {indexSelectedHeaderR2[2]} - Value: {sampleSelection.DisplayHeaderR23}");
            }
            else
            {
                indexSelectedHeaderR2[2] = -1;
                sampleSelection.DisplayHeaderR23 = string.Empty;
            }

            if (activeMateriality == 3)
            {
                indexSelectedHeaderR3[2] = listDropdownPop3.FindIndex(x => x.Equals(e.Value.ToString()));
                sampleSelection.DisplayHeaderR33 = e.Value.ToString();
                System.Diagnostics.Debug.WriteLine($"Trigger SetSelectedHeader3 Index: {indexSelectedHeaderR3[2]} - Value: {sampleSelection.DisplayHeaderR33}");
            }
            else
            {
                indexSelectedHeaderR3[2] = -1;
                sampleSelection.DisplayHeaderR33 = string.Empty;
            }
        }
    }

    //handles selected materiality field 4 change
    private void SetSelectedHeader4(ChangeEventArgs e)
    {
        if (e.Value.ToString() != string.Empty)
        {

            if (activeMateriality == 1)
            {
                indexSelectedHeaderR1[3] = listDropdownPop1.FindIndex(x => x.Equals(e.Value.ToString()));
                sampleSelection.DisplayHeaderR14 = e.Value.ToString();
                System.Diagnostics.Debug.WriteLine($"Trigger SetSelectedHeader1 Index: {indexSelectedHeaderR1[3]} - Value: {sampleSelection.DisplayHeaderR14}");
            }
            else
            {
                indexSelectedHeaderR1[3] = -1;
                sampleSelection.DisplayHeaderR14 = string.Empty;

            }

            if (activeMateriality == 2)
            {
                indexSelectedHeaderR2[3] = listDropdownPop2.FindIndex(x => x.Equals(e.Value.ToString()));
                sampleSelection.DisplayHeaderR24 = e.Value.ToString();
                System.Diagnostics.Debug.WriteLine($"Trigger SetSelectedHeader2 Index: {indexSelectedHeaderR2[3]} - Value: {sampleSelection.DisplayHeaderR24}");
            }
            else
            {
                indexSelectedHeaderR2[3] = -1;
                sampleSelection.DisplayHeaderR24 = string.Empty;
            }

            if (activeMateriality == 3)
            {
                indexSelectedHeaderR3[3] = listDropdownPop3.FindIndex(x => x.Equals(e.Value.ToString()));
                sampleSelection.DisplayHeaderR34 = e.Value.ToString();
                System.Diagnostics.Debug.WriteLine($"Trigger SetSelectedHeader3 Index: {indexSelectedHeaderR3[3]} - Value: {sampleSelection.DisplayHeaderR34}");
            }
            else
            {
                indexSelectedHeaderR3[3] = -1;
                sampleSelection.DisplayHeaderR34 = string.Empty;
            }
        }
    }

    //handles selected materiality field 4 change
    private void SetSelectedHeader5(ChangeEventArgs e)
    {
        if (e.Value.ToString() != string.Empty)
        {

            if (activeMateriality == 1)
            {
                indexSelectedHeaderR1[4] = listDropdownPop1.FindIndex(x => x.Equals(e.Value.ToString()));
                sampleSelection.DisplayHeaderR15 = e.Value.ToString();
                System.Diagnostics.Debug.WriteLine($"Trigger SetSelectedHeader1 Index: {indexSelectedHeaderR1[4]} - Value: {sampleSelection.DisplayHeaderR15}");
            }
            else
            {
                indexSelectedHeaderR1[4] = -1;
                sampleSelection.DisplayHeaderR15 = string.Empty;

            }

            if (activeMateriality == 2)
            {
                indexSelectedHeaderR2[4] = listDropdownPop2.FindIndex(x => x.Equals(e.Value.ToString()));
                sampleSelection.DisplayHeaderR25 = e.Value.ToString();
                System.Diagnostics.Debug.WriteLine($"Trigger SetSelectedHeader2 Index: {indexSelectedHeaderR2[4]} - Value: {sampleSelection.DisplayHeaderR25}");
            }
            else
            {
                indexSelectedHeaderR2[4] = -1;
                sampleSelection.DisplayHeaderR25 = string.Empty;
            }

            if (activeMateriality == 3)
            {
                indexSelectedHeaderR3[4] = listDropdownPop3.FindIndex(x => x.Equals(e.Value.ToString()));
                sampleSelection.DisplayHeaderR35 = e.Value.ToString();
                System.Diagnostics.Debug.WriteLine($"Trigger SetSelectedHeader3 Index: {indexSelectedHeaderR3[4]} - Value: {sampleSelection.DisplayHeaderR35}");
            }
            else
            {
                indexSelectedHeaderR3[4] = -1;
                sampleSelection.DisplayHeaderR35 = string.Empty;
            }
        }
    }

    //handles transactional and materiality uploading file population
    //private async void HandleFileSelected(IFileListEntry[] files) - Old process 
    private async void HandleFileSelected(FileUpload fileUpload)
    {

        ResetTM();
        isEnableRemoveFile = false;
        //string newFileName = string.Empty;
        //var file = files.FirstOrDefault();
        if (fileUpload != null && fileUpload.IFileEntry != null)
        {
            isDisableMateriality = true;
            var ms = new MemoryStream();
            //await file.Data.CopyToAsync(ms);
            await fileUpload.IFileEntry.Data.CopyToAsync(ms);

            //upload file and get response
            var response = await SelectionService.UploadFileAsync(ms, fileUpload.IFileEntry.Name, Http);

            if (response.StatusCode == System.Net.HttpStatusCode.OK)
            {

                //return filename
                sampleSelection.PopulationFile = response.Content.ReadAsStringAsync().Result.ToString();
                toastService.ShowInfo($"Successfully uploaded Population File {sampleSelection.PopulationFile}");

                //listPopulation1 = new List<List<string>>();
                //listDropdownPop1 = new List<string>();
                //listPopulationContent1 = new List<List<string>>();

                listPopulation1 = await SelectionService.SetPopulationTM2Async(sampleSelection.PopulationFile, 1, Http);
                if (listPopulation1 != null && listPopulation1.Count > 0)
                {
                    listPopulationContent1 = SelectionService.GetListPopulationContentUniqueAsync(listPopulation1);
                    listDropdownPop1 = await SelectionService.SetDropDownPopulationAsync2(listPopulation1);
                    sampleSelection.PopulationByRound1 = listPopulationContent1.Count;
                }


                //listPopulation2 = new List<List<string>>();
                //listPopulationContent2 = new List<List<string>>();
                //listDropdownPop2 = new List<string>();

                listPopulation2 = await SelectionService.SetPopulationTM2Async(sampleSelection.PopulationFile, 2, Http);
                if (listPopulation2 != null && listPopulation2.Count > 0)
                {
                    listPopulationContent2 = SelectionService.GetListPopulationContentUniqueAsync(listPopulation2);
                    listDropdownPop2 = await SelectionService.SetDropDownPopulationAsync2(listPopulation2);
                    sampleSelection.PopulationByRound2 = listPopulationContent2.Count;
                }


                //listPopulation3 = new List<List<string>>();
                //listDropdownPop3 = new List<string>();
                //listPopulationContent3 = new List<List<string>>();

                listPopulation3 = await SelectionService.SetPopulationTM2Async(sampleSelection.PopulationFile, 3, Http);
                if (listPopulation3 != null && listPopulation3.Count > 0)
                {
                    listPopulationContent3 = SelectionService.GetListPopulationContentUniqueAsync(listPopulation3);
                    listDropdownPop3 = await SelectionService.SetDropDownPopulationAsync2(listPopulation3);
                    sampleSelection.PopulationByRound3 = listPopulationContent3.Count;
                }


                ComputeRound(false, 0);
                isDisableMateriality = false;
                SetActiveMateriality();
                isEnableRemoveFile = true;


            }
            else
            {

                ResetTM();
                isDisableMateriality = true;
                SetActiveMateriality();

                toastService.ShowError($"Failed to upload file {fileUpload.IFileEntry.Name.ToString()}");
            }

        }
        else
        {

            ResetTM();
            isDisableMateriality = true;
        }


        this.StateHasChanged();

    }

    //this function will compute annual sample size
    private void ComputeRound(bool isSpecificRow, int index)
    {
        try
        {
            if (version != "3")
            {
                if (sampleSelection.Risk != string.Empty
                    && sampleSelection.Frequency != string.Empty
                    && sampleSelection.ExternalAuditor != string.Empty
                    && sampleSelection.Risk != null
                    && sampleSelection.Frequency != null
                    && sampleSelection.ExternalAuditor != null
                    )
                {

                    //daily, weekly, monthly computation
                    var sizeValue = listSampleSize.Where(
                        x => x.Risk == sampleSelection.Risk &&
                        x.Frequency == sampleSelection.Frequency &&
                        x.ExternalAuditor == sampleSelection.ExternalAuditor).Select(size => size.SizeValue);
                    sampleSelection.AnnualSampleSize = sizeValue.First();

                    GenerateTestRound(isSpecificRow, index);
                }
            }
            else
            {
                if (sampleSelection.Risk != string.Empty
                    && sampleSelection.ExternalAuditor != string.Empty
                    && sampleSelection.Risk != null
                    && sampleSelection.ExternalAuditor != null
                    )
                {
                    GenerateTestRound(isSpecificRow, index);
                }



            }
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine(ex.ToString());
            //throw;
        }


        this.StateHasChanged();
    }

    #region Date range variable and events for round 1, round 2 and round 3

    //Set default value
    //DateTimeOffset? StartDate1 { get; set; } = DateTime.Today;
    //DateTimeOffset? StartDate2 { get; set; } = DateTime.Today.AddMonths(2);
    //DateTimeOffset? StartDate3 { get; set; } = DateTime.Today.AddMonths(4);
    //DateTimeOffset? EndDate1 { get; set; } = DateTime.Today.AddMonths(1);
    //DateTimeOffset? EndDate2 { get; set; } = DateTime.Today.AddMonths(3);
    //DateTimeOffset? EndDate3 { get; set; } = DateTime.Today.AddMonths(5);

    //Set null value

    DateTimeOffset? StartDate1 { get; set; }
    DateTimeOffset? StartDate2 { get; set; }
    DateTimeOffset? StartDate3 { get; set; }

    DateTimeOffset? EndDate1 { get; set; }
    DateTimeOffset? EndDate2 { get; set; }
    DateTimeOffset? EndDate3 { get; set; }

    List<string> events { get; set; } = new List<string>();

    public void OnRangeSelect1(DateRange range)
    {
        //Use range.Start and range.End here
        events.Add($"Range {range.Start} - {range.End} selected");
        sampleSelection.Round1Start = range.Start;
        sampleSelection.Round1End = range.End;
        roundSelected = 1;
        ComputeRound(false, 0);

    }

    public void OnRangeSelect2(DateRange range)
    {
        //Use range.Start and range.End here

        events.Add($"Range {range.Start} - {range.End} selected");
        sampleSelection.Round2Start = range.Start.Date;
        sampleSelection.Round2End = range.End.Date;
        roundSelected = 2;
        ComputeRound(false, 0);
        //GenerateTestRound();
    }

    public void OnRangeSelect3(DateRange range)
    {
        //Use range.Start and range.End here
        events.Add($"Range {range.Start} - {range.End} selected");
        sampleSelection.Round3Start = range.Start.Date;
        sampleSelection.Round3End = range.End.Date;
        roundSelected = 3;
        ComputeRound(false, 0);
        //GenerateTestRound();
    }

    #endregion

    public void GenerateTestRound(bool isSpecificRow, int index)
    {

        //check fields
        if (sampleSelection.ExternalAuditor != null
            && sampleSelection.Risk != string.Empty
            && sampleSelection.Q4R3SampleRequired != string.Empty)
        {
            //computation if version is 2 or adjusted
            if (version == "2")
            {
                int startMonth = 13;
                int remainingMonth = 0;
                if (StartDate1 != null && StartDate1.Value.DateTime.Month <= startMonth)
                {
                    startMonth = StartDate1.Value.DateTime.Month;
                }
                else if (StartDate2 != null && StartDate2.Value.DateTime.Month <= startMonth)
                {
                    startMonth = StartDate2.Value.DateTime.Month;
                }
                else if (StartDate2 != null && StartDate3.Value.DateTime.Month <= startMonth)
                {
                    startMonth = StartDate3.Value.DateTime.Month;
                }

                if (startMonth < 13 && sampleSelection.AnnualSampleSize != null)
                {
                    remainingMonth = (12 - startMonth) + 1;
                    decimal size = (decimal)sampleSelection.AnnualSampleSize / 12;

                    sampleSelection.AnnualSampleSize = (int)(Math.Round(size * remainingMonth, MidpointRounding.ToEven));
                }

            }

            if (StartDate1 != null && EndDate1 != null)
            {
                if (version != "3")
                {
                    SetPopulation1();
                }
                else
                {
                    sampleSelection.DaysPeriodRound1 = (int)(sampleSelection.Round1End - sampleSelection.Round1Start).Value.TotalDays + 1;
                    SetPopulationTM();
                }
                SampleRound1();
            }

            if (StartDate2 != null && EndDate2 != null)
            {
                if (version != "3")
                {
                    SetPopulation2();

                }
                else
                {
                    sampleSelection.DaysPeriodRound2 = (int)(sampleSelection.Round2End - sampleSelection.Round2Start).Value.TotalDays + 1;
                    SetPopulationTM();
                }
                SampleRound2();
            }

            if (StartDate3 != null && EndDate3 != null)
            {
                if (version != "3")
                {
                    SetPopulation3();
                }
                else
                {
                    sampleSelection.DaysPeriodRound3 = (int)(sampleSelection.Round3End - sampleSelection.Round3Start).Value.TotalDays + 1;
                    SetPopulationTM();
                }
                SampleRound3();
            }


            //Generate Test Round
            switch (roundSelected)
            {
                case 1:
                    GenerateRound1(isSpecificRow, index);
                    break;
                case 2:
                    GenerateRound2(isSpecificRow, index);
                    break;
                case 3:
                    GenerateRound3(isSpecificRow, index);
                    break;
            }

            SetActiveMateriality();
        }
    }

    //set population for transactional and materiality
    private void SetPopulationTM()
    {
        sampleSelection.PopulationByRoundTot = sampleSelection.PopulationByRound1
               + sampleSelection.PopulationByRound2
               + sampleSelection.PopulationByRound3;

        sampleSelection.DaysPeriodRoundTot = sampleSelection.DaysPeriodRound1
            + sampleSelection.DaysPeriodRound2
            + sampleSelection.DaysPeriodRound3;

        if (sampleSelection.PopulationByRoundTot != 0 && sampleSelection.DaysPeriodRoundTot != 0)
        {

            double roundPerPeriod = (double)(sampleSelection.PopulationByRoundTot) / (double)(sampleSelection.DaysPeriodRoundTot);
            System.Diagnostics.Debug.WriteLine($"Round Per Period: {roundPerPeriod}");

            if (StartDate1 != null)
            {
                if (Mod(StartDate1.Value.Year, 400) == 0 || (Mod(StartDate1.Value.Year, 4) == 0 && Mod(StartDate1.Value.Year, 100) != 0))
                {
                    double tempAnnual = (Math.Round(roundPerPeriod * 366, MidpointRounding.ToEven));
                    sampleSelection.AnnualPopulation = (int)(Math.Round(roundPerPeriod * 366, MidpointRounding.ToEven));
                    System.Diagnostics.Debug.WriteLine($"Temp Annual: {tempAnnual}");
                }
                else
                {
                    double tempAnnual = (Math.Round(roundPerPeriod * 365, MidpointRounding.ToEven));
                    sampleSelection.AnnualPopulation = (int)(Math.Round(roundPerPeriod * 365, MidpointRounding.ToEven));
                    System.Diagnostics.Debug.WriteLine($"Temp Annual: {tempAnnual}");
                }
            }
            else
            {
                double tempAnnual = (Math.Round(roundPerPeriod * 365, MidpointRounding.ToEven));
                sampleSelection.AnnualPopulation = (int)(Math.Round(roundPerPeriod * 365, MidpointRounding.ToEven));
                System.Diagnostics.Debug.WriteLine($"Temp Annual: {tempAnnual}");
            }

        }

        System.Diagnostics.Debug.WriteLine($"Ext Editor: {sampleSelection.ExternalAuditor}");
        System.Diagnostics.Debug.WriteLine($"Risk: {sampleSelection.Risk}");
        System.Diagnostics.Debug.WriteLine($"Annual Population: {sampleSelection.AnnualPopulation}");


        //materiality and transactional computation
        var sizeValue = listSampleSize.Where(x =>
        sampleSelection.AnnualPopulation >= x.StartPopulation &&
        sampleSelection.AnnualPopulation <= x.EndPopulation &&
        x.ExternalAuditor == sampleSelection.ExternalAuditor &&
        x.Risk == sampleSelection.Risk);

        if (sizeValue != null)
        {

            sampleSelection.AnnualSampleSize = sizeValue.Select(size => size.SizeValue).FirstOrDefault();
            sampleSelection.Frequency = sizeValue.Select(size => size.Frequency).FirstOrDefault();

            ListFrequency = new List<Frequency> {
                        new Frequency {
                                Freq = sampleSelection.Frequency,
                                IntValue = sampleSelection.AnnualSampleSize
                            }
                        };

        }


        this.StateHasChanged();
    }

    //set population for daily/weekly/monthly for round 1
    private void SetPopulation1()
    {
        if (StartDate1 != null && EndDate1 != null && version != "3" && sampleSelection.Frequency != null)
        {

            switch (sampleSelection.Frequency)
            {
                case "Daily":
                    sampleSelection.PopulationByRound1 = (int)(sampleSelection.Round1End - sampleSelection.Round1Start).Value.TotalDays + 1;
                    break;
                case "Weekly":
                    //sampleSelection.PopulationByRound1 = WeekDiff(sampleSelection.Round1Start.Value.DateTime, sampleSelection.Round1End.Value.DateTime, DayOfWeek.Monday) + 1;
                    sampleSelection.PopulationByRound1 = (int)Math.Round(((sampleSelection.Round1End - sampleSelection.Round1Start).Value.TotalDays) / 7, MidpointRounding.ToEven);
                    break;
                case "Monthly":
                    sampleSelection.PopulationByRound1 = (int)Math.Round(((sampleSelection.Round1End - sampleSelection.Round1Start).Value.TotalDays) / 30, MidpointRounding.ToEven);
                    break;
            }
        }

    }

    //set population for daily/weekly/monthly for round 2
    private void SetPopulation2()
    {
        if (StartDate2 != null && EndDate2 != null && version != "3" && sampleSelection.Frequency != null)
        {

            switch (sampleSelection.Frequency)
            {
                case "Daily":
                    sampleSelection.PopulationByRound2 = (int)(sampleSelection.Round2End - sampleSelection.Round2Start).Value.TotalDays + 1;
                    break;
                case "Weekly":
                    //sampleSelection.PopulationByRound1 = WeekDiff(sampleSelection.Round1Start.Value.DateTime, sampleSelection.Round1End.Value.DateTime, DayOfWeek.Monday) + 1;
                    sampleSelection.PopulationByRound2 = (int)Math.Round(((sampleSelection.Round2End - sampleSelection.Round2Start).Value.TotalDays) / 7, MidpointRounding.ToEven);
                    break;
                case "Monthly":
                    sampleSelection.PopulationByRound2 = (int)Math.Round(((sampleSelection.Round2End - sampleSelection.Round2Start).Value.TotalDays) / 30, MidpointRounding.ToEven);
                    break;
            }
        }

    }

    //set population for daily/weekly/monthly for round 3
    private void SetPopulation3()
    {
        if (StartDate3 != null && EndDate3 != null && version != "3" && sampleSelection.Frequency != null)
        {

            switch (sampleSelection.Frequency)
            {
                case "Daily":
                    sampleSelection.PopulationByRound3 = (int)(sampleSelection.Round3End - sampleSelection.Round3Start).Value.TotalDays + 1;
                    break;
                case "Weekly":
                    //sampleSelection.PopulationByRound1 = WeekDiff(sampleSelection.Round1Start.Value.DateTime, sampleSelection.Round1End.Value.DateTime, DayOfWeek.Monday) + 1;
                    sampleSelection.PopulationByRound3 = (int)Math.Round(((sampleSelection.Round3End - sampleSelection.Round3Start).Value.TotalDays) / 7, MidpointRounding.ToEven);
                    break;
                case "Monthly":
                    sampleSelection.PopulationByRound3 = (int)Math.Round(((sampleSelection.Round3End - sampleSelection.Round3Start).Value.TotalDays) / 30, MidpointRounding.ToEven);
                    break;
            }
        }

    }

    //set sample round 1
    private void SampleRound1()
    {
        if (listDropDown != null
            && sampleSelection.AnnualSampleSize != null
            && sampleSelection.CountSampleQ4R3 != null)
        {

            decimal totalRound1 = 0;
            decimal round1Percent = 0;
            int round1 = 0;

            var percentVal = listDropDown.Where(x => x.ExternalAuditor == sampleSelection.ExternalAuditor).Select(size => size.Percent).FirstOrDefault();
            //var percentVal = sizeValue;

            decimal.TryParse(percentVal.ToString(), out round1Percent);

            //check first if Q4 is required
            if (sampleSelection.CountSampleQ4R3 > 0)
            {

                //Then we validate round 1 population if it is valid with round 3 population
                totalRound1 = (decimal.Parse(sampleSelection.AnnualSampleSize.ToString()) - sampleSelection.CountSampleQ4R3.Value) * (round1Percent / 100);
                sampleSelection.SamplesByRound3 = sampleSelection.CountSampleQ4R3.Value;
                round1 = (int)(totalRound1);
            }
            else
            {
                //get test round base on dropdown percent for round 1
                totalRound1 = decimal.Parse(sampleSelection.AnnualSampleSize.ToString()) * (round1Percent / 100);
                //round1 = random.Next(0, (int)(totalRound));
                round1 = (int)(totalRound1);
            }

            sampleSelection.SamplesByRound1 = sampleSelection.IsWTSampleTested == "Yes" ? round1 - sampleSelection.WTSampleTested : round1;
        }
    }

    //set sample round 2
    private void SampleRound2()
    {

        if (listDropDown != null
           && sampleSelection.AnnualSampleSize != null
           && sampleSelection.CountSampleQ4R3 != null)
        {
            decimal totalRound = 0;
            decimal round2Percent = 0;
            int round2 = 0;
            if (sampleSelection.CountSampleQ4R3 > 0)
            {
                sampleSelection.SamplesByRound3 = sampleSelection.CountSampleQ4R3.Value;
                //Then we validate round 1 population if it is valid with round 3 population
                round2 = sampleSelection.AnnualSampleSize.Value - (sampleSelection.SamplesByRound3 + sampleSelection.SamplesByRound1);
            }
            else
            {
                //get test round base on dropdown percent for round 1
                totalRound = decimal.Parse(sampleSelection.AnnualSampleSize.Value.ToString()) - sampleSelection.SamplesByRound1;

                var percentVal = listDropDown.Where(x => x.ExternalAuditor == sampleSelection.ExternalAuditor).Select(size => size.PercentRound2).FirstOrDefault();
                decimal.TryParse(percentVal.ToString(), out round2Percent);

                //Round 2 = (annual population - round 1) * 90%
                //round2 = (int)(totalRound * (decimal)(0.90));
                round2 = (int)(totalRound * (decimal)(round2Percent / 100));
            }

            sampleSelection.SamplesByRound2 = sampleSelection.IsWTSampleTested == "Yes" ? round2 - sampleSelection.WTSampleTested : round2;
        }

    }

    //set sample round 3
    private void SampleRound3()
    {
        if (listDropDown != null
           && sampleSelection.AnnualSampleSize != null
           && sampleSelection.CountSampleQ4R3 != null)
        {
            decimal totalRound = 0;
            int round3 = 0;
            //check first if Q4 is required
            if (sampleSelection.CountSampleQ4R3 > 0)
            {
                //Then we validate round 1 population if it is valid with round 3 population
                sampleSelection.SamplesByRound3 = sampleSelection.CountSampleQ4R3.Value;
                round3 = sampleSelection.CountSampleQ4R3.Value;
            }
            else
            {
                //generate test round base on dropdown percent for round 1
                totalRound = decimal.Parse(sampleSelection.AnnualSampleSize.Value.ToString())
                    - sampleSelection.SamplesByRound1
                    - sampleSelection.SamplesByRound2;

                round3 = (int)totalRound;
            }

            sampleSelection.SamplesByRound3 = sampleSelection.IsWTSampleTested == "Yes" ? round3 - sampleSelection.WTSampleTested : round3;
        }

    }

    //this function will remove value in list of testround
    private void RemoveTestRound(string roundName)
    {
        #region remove round if any in sample selection list test round
        if (sampleSelection.ListTestRound != null)
        {
            List<TestRound> listRound1 = new List<TestRound>();
            foreach (var item in sampleSelection.ListTestRound)
            {
                if (item.TestingRound == roundName)
                {
                    listRound1.Add(item);
                }
            }

            if (listRound1.Count > 0)
            {
                List<TestRound> newList = sampleSelection.ListTestRound.ToList();
                newList.RemoveAll(x => listRound1.Contains(x));
                sampleSelection.ListTestRound = newList;
                //sampleSelection.ListTestRound.RemoveAll(x => listRound1.Contains(x));
            }
        }

        #endregion

    }

    //generate random test round 1
    private void GenerateRound1(bool isSpecificRow, int index)
    {

        if (StartDate1 != null && sampleSelection.AnnualSampleSize != null)
        {
            Random random = new Random();

            if (!isSpecificRow)
                RemoveTestRound("Round 1");

            int workDaysRound1 = (int)GetWorkingDays(sampleSelection.Round1Start.Value.DateTime, sampleSelection.Round1End.Value.DateTime);

            if (version != "3" && workDaysRound1 > sampleSelection.SamplesByRound1)
            {
                #region Round 1 Random Daily/Weekly/Monthly
                int counterRound1 = isSpecificRow ? sampleSelection.SamplesByRound1 - 1 : 0;
                while (counterRound1 != sampleSelection.SamplesByRound1)
                {
                    System.Diagnostics.Debug.WriteLine($"{counterRound1} != {sampleSelection.SamplesByRound1}");

                    TimeSpan timeSpan = sampleSelection.Round1End.Value - sampleSelection.Round1Start.Value;
                    TimeSpan newSpan = new TimeSpan(0, random.Next(0, (int)timeSpan.TotalMinutes), 0);
                    DateTime newDate = sampleSelection.Round1Start.Value.DateTime + newSpan;

                    //Check if no duplicate date exists in list
                    //if (!sampleSelection.ListTestRound.Any(x => x.Date.Contains(newDate.ToString("MM/dd/yyyy")))
                    if (!sampleSelection.ListTestRound.Any(x => x.Date.Value.ToString("MM/dd/yyyy").Contains(newDate.ToString("MM/dd/yyyy")))
                    && newDate.DayOfWeek != DayOfWeek.Saturday
                    && newDate.DayOfWeek != DayOfWeek.Sunday)
                    {
                        counterRound1++;
                        TestRound testRound = new TestRound();
                        testRound.TestingRound = "Round 1";
                        testRound.A2Q2Samples = counterRound1.ToString();
                        testRound.Date = newDate;
                        testRound.MonthOnly = newDate.ToString("MMMM");
                        testRound.WeeklyOnly = newDate.AddDays(-(int)newDate.DayOfWeek + (int)DayOfWeek.Monday).ToString("MM/dd/yyyy");
                        testRound.Status = "Open";
                        if (isSpecificRow)
                        {
                            var updateList = sampleSelection.ListTestRound.FirstOrDefault(x => x.A2Q2Samples.Equals(index.ToString()));
                            if (updateList != null)
                            {
                                updateList.Date = testRound.Date;
                                updateList.MonthOnly = testRound.MonthOnly;
                                updateList.WeeklyOnly = testRound.WeeklyOnly;
                            }
                        }
                        else
                            sampleSelection.ListTestRound.Add(testRound);
                        System.Diagnostics.Debug.WriteLine($"Added Test {testRound.TestingRound } = {testRound.Date}");

                    }

                }

                isGenerated = true;
                #endregion
            }

            else if (version == "3"
                && sampleSelection.PopulationByRound1 >= sampleSelection.SamplesByRound1
                && sampleSelection.AnnualPopulation != null
                && sampleSelection.AnnualSampleSize != null
                && sampleSelection.Frequency != string.Empty
                && listPopulationContent1 != null)
            {
                //System.Diagnostics.Debug.WriteLine($"if ({sampleSelection.PopulationByRound1} >= {sampleSelection.SamplesByRound1})");
                //System.Diagnostics.Debug.WriteLine($"Annual Population: {sampleSelection.AnnualPopulation}");
                //System.Diagnostics.Debug.WriteLine($"Annual SampleSize: {sampleSelection.AnnualSampleSize}");
                //System.Diagnostics.Debug.WriteLine($"Frequency: {sampleSelection.Frequency}");
                //System.Diagnostics.Debug.WriteLine($"isMateriality: {sampleSelection.IsMateriality}");

                #region Round 1 Random Transactional and Materiality
                int counterRound1 = isSpecificRow ? sampleSelection.SamplesByRound1 - 1 : 0;

                List<string> tempUnique = new List<string>();
                List<List<string>> tempListUniqueContent1 = new List<List<string>>();
                List<List<string>> tempSort = new List<List<string>>();
                List<List<string>> tempList = new List<List<string>>();
                if (indexConsiderMat[0] != -1)
                {
                    tempList = SelectionService.GetListPopulationContentAsync(listPopulationContent1);
                    tempSort = SortListDesc(tempList, indexConsiderMat[0]).ToList();
                    tempSort = SelectionService.GetListPopulationContentUnique2Async(tempSort);

                }
                else
                {
                    tempSort.AddRange(listPopulationContent1);
                }

                tempListUniqueContent1.AddRange(tempSort);

                if (tempListUniqueContent1 != null && tempListUniqueContent1.Count > 0)
                {
                    IEnumerable<List<string>> rawData;
                    if (sampleSelection.IsMateriality != "Yes")
                    {
                        //var rawData = tempListUniqueContent1.OrderBy(x => random.Next()).Take(sampleSelection.SamplesByRound1);
                        if (!isSpecificRow)
                        {
                            rawData = tempListUniqueContent1.OrderBy(x => random.Next()).Take(sampleSelection.SamplesByRound1);
                        }
                        else
                        {
                            rawData = tempListUniqueContent1.OrderBy(x => random.Next());
                        }

                        foreach (var retData in rawData)
                        {
                            retData.FirstOrDefault();
                            if (!tempUnique.Contains(retData[retData.Count - 2]))
                            {
                                counterRound1++;
                                TestRound testRound = new TestRound();
                                testRound.TestingRound = "Round 1";
                                testRound.A2Q2Samples = counterRound1.ToString();
                                testRound.Status = "Open";

                                //Display base on selected option
                                if (indexSelectedHeaderR1[0] >= 0)
                                {
                                    testRound.HeaderRoundDisplay1 = sampleSelection.DisplayHeaderR11;
                                    testRound.ContentDisplay1 = (retData[indexSelectedHeaderR1[0]] != null ? retData[indexSelectedHeaderR1[0]] : string.Empty);
                                    System.Diagnostics.Debug.WriteLine($"GenerateRound 1: indexSelectedHeaderR1[0]={indexSelectedHeaderR1[0]} | HeaderRoundDisplay1={sampleSelection.DisplayHeaderR11}");
                                }

                                if (indexSelectedHeaderR1[1] >= 0)
                                {
                                    testRound.HeaderRoundDisplay2 = sampleSelection.DisplayHeaderR12;
                                    testRound.ContentDisplay2 = (retData[indexSelectedHeaderR1[1]] != null ? retData[indexSelectedHeaderR1[1]].ToString() : string.Empty);
                                    System.Diagnostics.Debug.WriteLine($"GenerateRound 1: indexSelectedHeaderR1[1]={indexSelectedHeaderR1[1]} | HeaderRoundDisplay2={sampleSelection.DisplayHeaderR12}");
                                }

                                if (indexSelectedHeaderR1[2] >= 0)
                                {
                                    testRound.HeaderRoundDisplay3 = sampleSelection.DisplayHeaderR13;
                                    testRound.ContentDisplay3 = (retData[indexSelectedHeaderR1[2]] != null ? retData[indexSelectedHeaderR1[2]].ToString() : string.Empty);
                                    System.Diagnostics.Debug.WriteLine($"GenerateRound 1: indexSelectedHeaderR1[2]={indexSelectedHeaderR1[2]} | HeaderRoundDisplay3={sampleSelection.DisplayHeaderR13}");
                                }

                                if (indexSelectedHeaderR1[3] >= 0)
                                {
                                    testRound.HeaderRoundDisplay4 = sampleSelection.DisplayHeaderR14;
                                    testRound.ContentDisplay4 = (retData[indexSelectedHeaderR1[3]] != null ? retData[indexSelectedHeaderR1[3]] : string.Empty);
                                    System.Diagnostics.Debug.WriteLine($"GenerateRound 1: indexSelectedHeaderR1[3]={indexSelectedHeaderR1[3]} | HeaderRoundDisplay4={sampleSelection.DisplayHeaderR14}");
                                }

                                if (indexSelectedHeaderR1[4] >= 0)
                                {
                                    testRound.HeaderRoundDisplay5 = sampleSelection.DisplayHeaderR15;
                                    testRound.ContentDisplay5 = (retData[indexSelectedHeaderR1[4]] != null ? retData[indexSelectedHeaderR1[4]] : string.Empty);
                                    System.Diagnostics.Debug.WriteLine($"GenerateRound 1: indexSelectedHeaderR1[4]={indexSelectedHeaderR1[4]} | HeaderRoundDisplay5={sampleSelection.DisplayHeaderR15}");
                                }

                                //sampleSelection.ListTestRound.Add(testRound);
                                //tempUnique.Add(retData[retData.Count - 2]);

                                //System.Diagnostics.Debug.WriteLine($"Counter {counterRound1}: {sampleSelection.SamplesByRound1} | UniqueID: {retData[retData.Count - 2]}");

                                if (isSpecificRow && testRound.ContentDisplay1 != null && testRound.ContentDisplay1 != string.Empty)
                                {
                                    var checkTestRoundExists = sampleSelection.ListTestRound.Where(x => x.ContentDisplay1.Equals(testRound.ContentDisplay1)).FirstOrDefault();
                                    if (checkTestRoundExists == null) //check if it exists in list of test round
                                    {
                                        var updateList = sampleSelection.ListTestRound.FirstOrDefault(x => x.A2Q2Samples.Equals(index.ToString()));
                                        if (updateList != null)
                                        {
                                            updateList.Date = testRound.Date;
                                            updateList.MonthOnly = testRound.MonthOnly;
                                            updateList.WeeklyOnly = testRound.WeeklyOnly;
                                            updateList.HeaderRoundDisplay1 = testRound.HeaderRoundDisplay1;
                                            updateList.ContentDisplay1 = testRound.ContentDisplay1;
                                            updateList.HeaderRoundDisplay2 = testRound.HeaderRoundDisplay2;
                                            updateList.ContentDisplay2 = testRound.ContentDisplay2;
                                            updateList.HeaderRoundDisplay3 = testRound.HeaderRoundDisplay3;
                                            updateList.ContentDisplay3 = testRound.ContentDisplay3;
                                            updateList.HeaderRoundDisplay4 = testRound.HeaderRoundDisplay4;
                                            updateList.ContentDisplay4 = testRound.ContentDisplay4;
                                            updateList.HeaderRoundDisplay5 = testRound.HeaderRoundDisplay5;
                                            updateList.ContentDisplay5 = testRound.ContentDisplay5;
                                            break;
                                        }
                                    }
                                }
                                else
                                {
                                    sampleSelection.ListTestRound.Add(testRound);
                                    tempUnique.Add(retData[retData.Count - 2]);
                                }



                            }
                            else
                            {
                                System.Diagnostics.Debug.WriteLine($"Temp Unique Exists Round 1: {retData[retData.Count - 2]}");
                            }
                        }
                    }
                    else
                    {
                        //we only get the first row in the list of unique content

                        //rawData = tempListUniqueContent1.Take(sampleSelection.SamplesByRound1);

                        if (isSpecificRow)
                        {
                            tempListUniqueContent1.RemoveAt(index);
                            counterRound1 = 0;
                        }

                        rawData = tempListUniqueContent1;

                        foreach (var retData in rawData)
                        {

                            if (counterRound1 != sampleSelection.SamplesByRound1)
                            {
                                retData.FirstOrDefault();
                                if (!tempUnique.Contains(retData[retData.Count - 2]))
                                {
                                    counterRound1++;
                                    TestRound testRound = new TestRound();
                                    testRound.TestingRound = "Round 1";
                                    testRound.A2Q2Samples = counterRound1.ToString();
                                    testRound.Status = "Open";

                                    //Display base on selected option
                                    if (indexSelectedHeaderR1[0] >= 0)
                                    {
                                        testRound.HeaderRoundDisplay1 = sampleSelection.DisplayHeaderR11;
                                        testRound.ContentDisplay1 = (retData[indexSelectedHeaderR1[0]] != null ? retData[indexSelectedHeaderR1[0]] : string.Empty);
                                        System.Diagnostics.Debug.WriteLine($"GenerateRound 1: indexSelectedHeaderR11={indexSelectedHeaderR1[0]}");
                                    }

                                    if (indexSelectedHeaderR1[1] >= 0)
                                    {
                                        testRound.HeaderRoundDisplay2 = sampleSelection.DisplayHeaderR12;
                                        testRound.ContentDisplay2 = (retData[indexSelectedHeaderR1[1]] != null ? retData[indexSelectedHeaderR1[1]] : string.Empty);
                                        System.Diagnostics.Debug.WriteLine($"GenerateRound 1: indexSelectedHeaderR12={indexSelectedHeaderR1[1]}");
                                    }

                                    if (indexSelectedHeaderR1[2] >= 0)
                                    {
                                        testRound.HeaderRoundDisplay3 = sampleSelection.DisplayHeaderR13;
                                        testRound.ContentDisplay3 = (retData[indexSelectedHeaderR1[2]] != null ? retData[indexSelectedHeaderR1[2]] : string.Empty);
                                        System.Diagnostics.Debug.WriteLine($"GenerateRound 1: indexSelectedHeaderR13={indexSelectedHeaderR1[2]}");
                                    }

                                    if (indexSelectedHeaderR1[3] >= 0)
                                    {
                                        testRound.HeaderRoundDisplay4 = sampleSelection.DisplayHeaderR14;
                                        testRound.ContentDisplay4 = (retData[indexSelectedHeaderR1[3]] != null ? retData[indexSelectedHeaderR1[3]] : string.Empty);
                                        System.Diagnostics.Debug.WriteLine($"GenerateRound 1: indexSelectedHeaderR14={indexSelectedHeaderR1[3]}");
                                    }

                                    if (indexSelectedHeaderR1[4] >= 0)
                                    {
                                        testRound.HeaderRoundDisplay5 = sampleSelection.DisplayHeaderR15;
                                        testRound.ContentDisplay5 = (retData[indexSelectedHeaderR1[4]] != null ? retData[indexSelectedHeaderR1[4]] : string.Empty);
                                        System.Diagnostics.Debug.WriteLine($"GenerateRound 1: indexSelectedHeaderR15={indexSelectedHeaderR1[4]}");
                                    }


                                    //sampleSelection.ListTestRound.Add(testRound);
                                    //tempUnique.Add(retData[retData.Count - 2]);

                                    //System.Diagnostics.Debug.WriteLine($"Counter {counterRound1}: {sampleSelection.SamplesByRound1}");

                                    if (isSpecificRow && testRound.ContentDisplay1 != null && testRound.ContentDisplay1 != string.Empty)
                                    {
                                        var checkTestRoundExists = sampleSelection.ListTestRound.Where(x => x.ContentDisplay1.Equals(testRound.ContentDisplay1)).FirstOrDefault();
                                        if (checkTestRoundExists == null) //check if it exists in list of test round
                                        {
                                            var updateList = sampleSelection.ListTestRound.FirstOrDefault(x => x.A2Q2Samples.Equals(index.ToString()));
                                            if (updateList != null)
                                            {
                                                updateList.Date = testRound.Date;
                                                updateList.MonthOnly = testRound.MonthOnly;
                                                updateList.WeeklyOnly = testRound.WeeklyOnly;
                                                updateList.HeaderRoundDisplay1 = testRound.HeaderRoundDisplay1;
                                                updateList.ContentDisplay1 = testRound.ContentDisplay1;
                                                updateList.HeaderRoundDisplay2 = testRound.HeaderRoundDisplay2;
                                                updateList.ContentDisplay2 = testRound.ContentDisplay2;
                                                updateList.HeaderRoundDisplay3 = testRound.HeaderRoundDisplay3;
                                                updateList.ContentDisplay3 = testRound.ContentDisplay3;
                                                updateList.HeaderRoundDisplay4 = testRound.HeaderRoundDisplay4;
                                                updateList.ContentDisplay4 = testRound.ContentDisplay4;
                                                updateList.HeaderRoundDisplay5 = testRound.HeaderRoundDisplay5;
                                                updateList.ContentDisplay5 = testRound.ContentDisplay5;
                                                break;
                                            }
                                        }
                                    }
                                    else
                                    {
                                        sampleSelection.ListTestRound.Add(testRound);
                                        tempUnique.Add(retData[retData.Count - 2]);
                                    }
                                }
                                else
                                {
                                    System.Diagnostics.Debug.WriteLine($"Temp Unique Exists Round 1: {retData[retData.Count - 2]}");
                                }
                            }
                            else
                            {
                                break;
                            }

                        }
                    }

                }




                isGenerated = true;
                #endregion



            }

            else
            {
                toastService.ShowError($"An error occurred in Generating Round 1");
            }


            SortTestRound();
            this.StateHasChanged();
        }

    }

    //generate random test round 2
    private void GenerateRound2(bool isSpecificRow, int index)
    {

        if (StartDate2 != null && sampleSelection.AnnualSampleSize != null)
        {

            //System.Diagnostics.Debug.WriteLine($"if ({sampleSelection.PopulationByRound1} >= {sampleSelection.SamplesByRound1})");
            //System.Diagnostics.Debug.WriteLine($"Annual Population: {sampleSelection.AnnualPopulation}");
            //System.Diagnostics.Debug.WriteLine($"Annual SampleSize: {sampleSelection.AnnualSampleSize}");
            //System.Diagnostics.Debug.WriteLine($"Frequency: {sampleSelection.Frequency}");
            //System.Diagnostics.Debug.WriteLine($"isMateriality: {sampleSelection.IsMateriality}");

            Random random = new Random();

            if (!isSpecificRow)
                RemoveTestRound("Round 2");

            int workDaysRound2 = (int)GetWorkingDays(sampleSelection.Round2Start.Value.DateTime, sampleSelection.Round2End.Value.DateTime);

            if (version != "3" && workDaysRound2 > sampleSelection.SamplesByRound2)
            {
                #region Round 2 Random
                int counterRound1 = sampleSelection.SamplesByRound1;
                int counterRound2 = isSpecificRow ? sampleSelection.SamplesByRound2 - 1 : 0;

                while (counterRound2 != sampleSelection.SamplesByRound2)
                {
                    TimeSpan timeSpan = sampleSelection.Round2End.Value - sampleSelection.Round2Start.Value;
                    TimeSpan newSpan = new TimeSpan(0, random.Next(0, (int)timeSpan.TotalMinutes), 0);
                    DateTime newDate = sampleSelection.Round2Start.Value.DateTime + newSpan;

                    //Check if no duplicate date exists in list
                    //if (!sampleSelection.ListTestRound.Any(x => x.Date.Contains(newDate.ToString("MM/dd/yyyy")))
                    if (!sampleSelection.ListTestRound.Any(x => x.Date.Value.ToString("MM/dd/yyyy").Contains(newDate.ToString("MM/dd/yyyy")))
                    && newDate.DayOfWeek != DayOfWeek.Saturday
                    && newDate.DayOfWeek != DayOfWeek.Sunday)
                    {
                        counterRound1++;
                        counterRound2++;
                        TestRound testRound = new TestRound();
                        testRound.TestingRound = "Round 2";
                        testRound.A2Q2Samples = counterRound1.ToString();
                        testRound.Date = newDate;
                        testRound.MonthOnly = newDate.ToString("MMMM");
                        testRound.WeeklyOnly = newDate.AddDays(-(int)newDate.DayOfWeek + (int)DayOfWeek.Monday).ToString("MM/dd/yyyy");
                        testRound.Status = "Open";
                        //sampleSelection.ListTestRound.Add(testRound);
                        if (isSpecificRow)
                        {
                            var updateList = sampleSelection.ListTestRound.FirstOrDefault(x => x.A2Q2Samples.Equals(index.ToString()));
                            if (updateList != null)
                            {
                                updateList.Date = testRound.Date;
                                updateList.MonthOnly = testRound.MonthOnly;
                                updateList.WeeklyOnly = testRound.WeeklyOnly;
                            }
                        }
                        else
                            sampleSelection.ListTestRound.Add(testRound);
                    }
                }

                isGenerated = true;
                #endregion
            }

            else if (version == "3"
                && sampleSelection.PopulationByRound2 >= sampleSelection.SamplesByRound2
                && sampleSelection.AnnualPopulation != null
                && sampleSelection.AnnualSampleSize != null
                && sampleSelection.Frequency != string.Empty
                && listPopulationContent2 != null)
            {

                //System.Diagnostics.Debug.WriteLine($"if ({sampleSelection.PopulationByRound2} >= {sampleSelection.SamplesByRound2})");
                //System.Diagnostics.Debug.WriteLine($"Annual Population: {sampleSelection.AnnualPopulation}");
                //System.Diagnostics.Debug.WriteLine($"Annual SampleSize: {sampleSelection.AnnualSampleSize}");
                //System.Diagnostics.Debug.WriteLine($"Frequency: {sampleSelection.Frequency}");
                //System.Diagnostics.Debug.WriteLine($"isMateriality: {sampleSelection.IsMateriality}");

                #region Round 2 Random Transactional and Materiality
                int counterRound1 = sampleSelection.SamplesByRound1;
                int counterRound2 = isSpecificRow ? sampleSelection.SamplesByRound2 - 1 : 0;

                List<string> tempUnique = new List<string>();
                List<List<string>> tempListUniqueContent2 = new List<List<string>>();
                List<List<string>> tempSort = new List<List<string>>();
                List<List<string>> tempList = new List<List<string>>();
                if (indexConsiderMat[1] != -1)
                {
                    //tempSort = SortListDesc(listPopulationContent2, indexConsiderMat[1]).ToList();
                    tempList = SelectionService.GetListPopulationContentAsync(listPopulationContent2);
                    tempSort = SortListDesc(tempList, indexConsiderMat[1]).ToList();
                    tempSort = SelectionService.GetListPopulationContentUnique2Async(tempSort);
                }
                else
                {
                    tempSort.AddRange(listPopulationContent2);
                }

                tempListUniqueContent2.AddRange(tempSort);

                if (tempListUniqueContent2 != null && tempListUniqueContent2.Count > 0)
                {

                    if (sampleSelection.IsMateriality != "Yes")
                    {
                        //var rawData = tempListUniqueContent2.OrderBy(x => random.Next()).Take(sampleSelection.SamplesByRound2);

                        IEnumerable<List<string>> rawData;
                        if (!isSpecificRow)
                        {
                            rawData = tempListUniqueContent2.OrderBy(x => random.Next()).Take(sampleSelection.SamplesByRound2);
                        }
                        else
                        {
                            rawData = tempListUniqueContent2.OrderBy(x => random.Next());
                        }

                        foreach (var retData in rawData)
                        {
                            retData.FirstOrDefault();
                            if (!tempUnique.Contains(retData[retData.Count - 2]))
                            {
                                counterRound1++;
                                counterRound2++;
                                TestRound testRound = new TestRound();
                                testRound.TestingRound = "Round 2";
                                testRound.A2Q2Samples = counterRound1.ToString();
                                testRound.Status = "Open";

                                //Display base on selected option
                                if (indexSelectedHeaderR2[0] >= 0)
                                {
                                    testRound.HeaderRoundDisplay1 = sampleSelection.DisplayHeaderR21;
                                    testRound.ContentDisplay1 = (retData[indexSelectedHeaderR2[0]] != null ? retData[indexSelectedHeaderR2[0]] : string.Empty);
                                    System.Diagnostics.Debug.WriteLine($"GenerateRound 2: indexSelectedHeaderR2[0]={indexSelectedHeaderR2[0]} | HeaderRoundDisplay1={sampleSelection.DisplayHeaderR21}");
                                }

                                if (indexSelectedHeaderR2[1] >= 0)
                                {
                                    testRound.HeaderRoundDisplay2 = sampleSelection.DisplayHeaderR22;
                                    testRound.ContentDisplay2 = (retData[indexSelectedHeaderR2[1]] != null ? retData[indexSelectedHeaderR2[1]] : string.Empty);
                                    System.Diagnostics.Debug.WriteLine($"GenerateRound 2: indexSelectedHeaderR2[1]={indexSelectedHeaderR2[1]} | HeaderRoundDisplay2={sampleSelection.DisplayHeaderR22}");
                                }

                                if (indexSelectedHeaderR2[2] >= 0)
                                {
                                    testRound.HeaderRoundDisplay3 = sampleSelection.DisplayHeaderR23;
                                    testRound.ContentDisplay3 = (retData[indexSelectedHeaderR2[2]] != null ? retData[indexSelectedHeaderR2[2]] : string.Empty);
                                    System.Diagnostics.Debug.WriteLine($"GenerateRound 2: indexSelectedHeaderR2[2]={indexSelectedHeaderR2[2]} | HeaderRoundDisplay3={sampleSelection.DisplayHeaderR23}");
                                }

                                if (indexSelectedHeaderR2[3] >= 0)
                                {
                                    testRound.HeaderRoundDisplay4 = sampleSelection.DisplayHeaderR24;
                                    testRound.ContentDisplay4 = (retData[indexSelectedHeaderR2[3]] != null ? retData[indexSelectedHeaderR2[3]] : string.Empty);
                                    System.Diagnostics.Debug.WriteLine($"GenerateRound 2: indexSelectedHeaderR2[3]={indexSelectedHeaderR2[3]} | HeaderRoundDisplay4={sampleSelection.DisplayHeaderR24}");
                                }

                                if (indexSelectedHeaderR2[4] >= 0)
                                {
                                    testRound.HeaderRoundDisplay5 = sampleSelection.DisplayHeaderR25;
                                    testRound.ContentDisplay5 = (retData[indexSelectedHeaderR2[4]] != null ? retData[indexSelectedHeaderR2[4]] : string.Empty);
                                    System.Diagnostics.Debug.WriteLine($"GenerateRound 2: indexSelectedHeaderR2[4]={indexSelectedHeaderR2[4]} | HeaderRoundDisplay5={sampleSelection.DisplayHeaderR25}");
                                }


                                sampleSelection.ListTestRound.Add(testRound);
                                tempUnique.Add(retData[retData.Count - 2]);

                                System.Diagnostics.Debug.WriteLine($"Counter {counterRound1}: {sampleSelection.SamplesByRound2}");

                                //if (tempListUniqueContent1.Count > 0)
                                //    tempListUniqueContent1.RemoveAt(0);

                                //tempListUniqueContent1 = await SelectionService.RemoveItemListUnique(tempListUniqueContent1, index.Value);
                            }
                            else
                            {
                                System.Diagnostics.Debug.WriteLine($"Temp Unique Exists Round 2: {retData[retData.Count - 2]}");
                            }
                        }
                    }
                    else
                    {
                        //we only get the first row in the list of unique content
                        var rawData = tempListUniqueContent2.Take(sampleSelection.SamplesByRound2);

                        if (isSpecificRow)
                        {
                            tempListUniqueContent2.RemoveAt(index);
                            counterRound2 = 0;
                        }

                        rawData = tempListUniqueContent2;

                        foreach (var retData in rawData)
                        {

                            if (counterRound2 != sampleSelection.SamplesByRound2)
                            {
                                retData.FirstOrDefault();
                                //Console.WriteLine($"Price: {retData[indexSelectedHeaderR2[2]]} | Index: {retData[retData.Count - 2]}");
                                if (!tempUnique.Contains(retData[retData.Count - 2]))
                                {
                                    counterRound1++;
                                    counterRound2++;
                                    TestRound testRound = new TestRound();
                                    testRound.TestingRound = "Round 2";
                                    testRound.A2Q2Samples = counterRound1.ToString();
                                    testRound.Status = "Open";

                                    //Display base on selected option
                                    if (indexSelectedHeaderR2[0] >= 0)
                                    {
                                        testRound.HeaderRoundDisplay1 = sampleSelection.DisplayHeaderR21;
                                        testRound.ContentDisplay1 = (retData[indexSelectedHeaderR2[0]] != null ? retData[indexSelectedHeaderR2[0]] : string.Empty);
                                        System.Diagnostics.Debug.WriteLine($"GenerateRound 2: indexSelectedHeaderR2={indexSelectedHeaderR2[0]} | ContentDisplay1: {testRound.ContentDisplay1}");
                                    }

                                    if (indexSelectedHeaderR2[1] >= 0)
                                    {
                                        testRound.HeaderRoundDisplay2 = sampleSelection.DisplayHeaderR22;
                                        testRound.ContentDisplay2 = (retData[indexSelectedHeaderR2[1]] != null ? retData[indexSelectedHeaderR2[1]] : string.Empty);
                                        System.Diagnostics.Debug.WriteLine($"GenerateRound 2: indexSelectedHeaderR2={indexSelectedHeaderR2[1]} | ContentDisplay2: {testRound.ContentDisplay2}");
                                    }

                                    if (indexSelectedHeaderR2[2] >= 0)
                                    {
                                        testRound.HeaderRoundDisplay3 = sampleSelection.DisplayHeaderR23;
                                        testRound.ContentDisplay3 = (retData[indexSelectedHeaderR2[2]] != null ? retData[indexSelectedHeaderR2[2]] : string.Empty);
                                        System.Diagnostics.Debug.WriteLine($"GenerateRound 2: indexSelectedHeaderR2={indexSelectedHeaderR2[2]} | ContentDisplay3: {testRound.ContentDisplay3}");
                                    }

                                    if (indexSelectedHeaderR2[3] >= 0)
                                    {
                                        testRound.HeaderRoundDisplay4 = sampleSelection.DisplayHeaderR24;
                                        testRound.ContentDisplay4 = (retData[indexSelectedHeaderR2[3]] != null ? retData[indexSelectedHeaderR2[3]] : string.Empty);
                                        System.Diagnostics.Debug.WriteLine($"GenerateRound 2: indexSelectedHeaderR2={indexSelectedHeaderR2[3]} | ContentDisplay4: {testRound.ContentDisplay4}");
                                    }

                                    if (indexSelectedHeaderR2[4] >= 0)
                                    {
                                        testRound.HeaderRoundDisplay5 = sampleSelection.DisplayHeaderR25;
                                        testRound.ContentDisplay5 = (retData[indexSelectedHeaderR2[4]] != null ? retData[indexSelectedHeaderR2[4]] : string.Empty);
                                        System.Diagnostics.Debug.WriteLine($"GenerateRound 2: indexSelectedHeaderR2={indexSelectedHeaderR2[4]} | ContentDisplay5: {testRound.ContentDisplay5}");
                                    }


                                    //sampleSelection.ListTestRound.Add(testRound);
                                    //tempUnique.Add(retData[retData.Count - 2]);

                                    //System.Diagnostics.Debug.WriteLine($"Counter {counterRound2}: {sampleSelection.SamplesByRound2}");

                                    if (isSpecificRow && testRound.ContentDisplay1 != null && testRound.ContentDisplay1 != string.Empty)
                                    {
                                        var checkTestRoundExists = sampleSelection.ListTestRound.Where(x => x.ContentDisplay1.Equals(testRound.ContentDisplay1)).FirstOrDefault();
                                        if (checkTestRoundExists == null) //check if it exists in list of test round
                                        {
                                            var updateList = sampleSelection.ListTestRound.FirstOrDefault(x => x.A2Q2Samples.Equals(index.ToString()));
                                            if (updateList != null)
                                            {
                                                updateList.Date = testRound.Date;
                                                updateList.MonthOnly = testRound.MonthOnly;
                                                updateList.WeeklyOnly = testRound.WeeklyOnly;
                                                updateList.HeaderRoundDisplay1 = testRound.HeaderRoundDisplay1;
                                                updateList.ContentDisplay1 = testRound.ContentDisplay1;
                                                updateList.HeaderRoundDisplay2 = testRound.HeaderRoundDisplay2;
                                                updateList.ContentDisplay2 = testRound.ContentDisplay2;
                                                updateList.HeaderRoundDisplay3 = testRound.HeaderRoundDisplay3;
                                                updateList.ContentDisplay3 = testRound.ContentDisplay3;
                                                updateList.HeaderRoundDisplay4 = testRound.HeaderRoundDisplay4;
                                                updateList.ContentDisplay4 = testRound.ContentDisplay4;
                                                updateList.HeaderRoundDisplay5 = testRound.HeaderRoundDisplay5;
                                                updateList.ContentDisplay5 = testRound.ContentDisplay5;
                                                break;
                                            }
                                        }
                                    }
                                    else
                                    {
                                        sampleSelection.ListTestRound.Add(testRound);
                                        tempUnique.Add(retData[retData.Count - 2]);
                                    }

                                    System.Diagnostics.Debug.WriteLine($"Counter {counterRound2}: {sampleSelection.SamplesByRound2}");


                                }
                                else
                                {
                                    System.Diagnostics.Debug.WriteLine($"Temp Unique Exists Round 2: {retData[retData.Count - 2]}");
                                }
                            }
                            else
                            {
                                break;
                            }

                        }
                    }

                }

                isGenerated = true;
                #endregion

            }
            else
            {
                toastService.ShowError($"An error occurred in Generating Round 2");
            }




            SortTestRound();
            this.StateHasChanged();
        }

    }

    //generate random test round 3
    private void GenerateRound3(bool isSpecificRow, int index)
    {
        if (StartDate3 != null && sampleSelection.AnnualSampleSize != null)
        {
            Random random = new Random();
            //decimal totalRound = 0;
            //int round3 = 0;

            if (!isSpecificRow)
                RemoveTestRound("Round 3");

            int workDaysRound3 = (int)GetWorkingDays(sampleSelection.Round3Start.Value.DateTime, sampleSelection.Round3End.Value.DateTime);

            if (version != "3" && workDaysRound3 > sampleSelection.SamplesByRound3)
            {
                #region Round 3 Random
                int counterRound1 = sampleSelection.SamplesByRound1 + sampleSelection.SamplesByRound2;
                int counterRound3 = isSpecificRow ? sampleSelection.SamplesByRound3 - 1 : 0;
                while (counterRound3 != sampleSelection.SamplesByRound3)
                {
                    TimeSpan timeSpan = sampleSelection.Round3End.Value - sampleSelection.Round3Start.Value;
                    TimeSpan newSpan = new TimeSpan(0, random.Next(0, (int)timeSpan.TotalMinutes), 0);
                    DateTime newDate = sampleSelection.Round3Start.Value.DateTime + newSpan;

                    //Check if no duplicate date exists in list
                    if (!sampleSelection.ListTestRound.Any(x => x.Date.Value.ToString("MM/dd/yyyy").Contains(newDate.ToString("MM/dd/yyyy")))
                        && newDate.DayOfWeek != DayOfWeek.Saturday
                        && newDate.DayOfWeek != DayOfWeek.Sunday)
                    {
                        counterRound1++;
                        counterRound3++;
                        TestRound testRound = new TestRound();
                        testRound.TestingRound = "Round 3";
                        testRound.A2Q2Samples = counterRound1.ToString();
                        testRound.Date = newDate;
                        testRound.MonthOnly = newDate.ToString("MMMM");
                        testRound.WeeklyOnly = newDate.AddDays(-(int)newDate.DayOfWeek + (int)DayOfWeek.Monday).ToString("MM/dd/yyyy");
                        testRound.Status = "Open";
                        //sampleSelection.ListTestRound.Add(testRound);
                        if (isSpecificRow)
                        {
                            var updateList = sampleSelection.ListTestRound.FirstOrDefault(x => x.A2Q2Samples.Equals(index.ToString()));
                            if (updateList != null)
                            {
                                updateList.Date = testRound.Date;
                                updateList.MonthOnly = testRound.MonthOnly;
                                updateList.WeeklyOnly = testRound.WeeklyOnly;
                            }
                        }
                        else
                            sampleSelection.ListTestRound.Add(testRound);
                    }
                }

                isGenerated = true;
                #endregion
            }

            else if (version == "3"
                && sampleSelection.PopulationByRound2 >= sampleSelection.SamplesByRound2
                && sampleSelection.AnnualPopulation != null
                && sampleSelection.AnnualSampleSize != null
                && sampleSelection.Frequency != string.Empty
                && listPopulationContent3 != null)
            {

                //System.Diagnostics.Debug.WriteLine($"if ({sampleSelection.PopulationByRound3} >= {sampleSelection.SamplesByRound3})");
                //System.Diagnostics.Debug.WriteLine($"Annual Population: {sampleSelection.AnnualPopulation}");
                //System.Diagnostics.Debug.WriteLine($"Annual SampleSize: {sampleSelection.AnnualSampleSize}");
                //System.Diagnostics.Debug.WriteLine($"Frequency: {sampleSelection.Frequency}");
                //System.Diagnostics.Debug.WriteLine($"isMateriality: {sampleSelection.IsMateriality}");

                #region Round 3 Random Transactional and Materiality
                int counterRound1 = sampleSelection.SamplesByRound1 + sampleSelection.SamplesByRound2;
                int counterRound3 = isSpecificRow ? sampleSelection.SamplesByRound3 - 1 : 0;

                List<string> tempUnique = new List<string>();
                List<List<string>> tempListUniqueContent3 = new List<List<string>>();
                List<List<string>> tempSort = new List<List<string>>();
                List<List<string>> tempList = new List<List<string>>();
                if (indexConsiderMat[2] != -1)
                {
                    //tempSort = SortListDesc(listPopulationContent3, indexConsiderMat[2]).ToList();
                    tempList = SelectionService.GetListPopulationContentAsync(listPopulationContent3);
                    tempSort = SortListDesc(tempList, indexConsiderMat[2]).ToList();
                    tempSort = SelectionService.GetListPopulationContentUnique2Async(tempSort);
                }
                else
                {
                    tempSort.AddRange(listPopulationContent3);
                }

                tempListUniqueContent3.AddRange(tempSort);

                if (tempListUniqueContent3 != null && tempListUniqueContent3.Count > 0)
                {
                    IEnumerable<List<string>> rawData;
                    if (sampleSelection.IsMateriality != "Yes")
                    {

                        if (!isSpecificRow)
                        {
                            rawData = tempListUniqueContent3.OrderBy(x => random.Next()).Take(sampleSelection.SamplesByRound3);
                        }
                        else
                        {
                            rawData = tempListUniqueContent3.OrderBy(x => random.Next());
                        }

                        foreach (var retData in rawData)
                        {

                            retData.FirstOrDefault();

                            if (!tempUnique.Contains(retData[retData.Count - 2]))
                            {
                                counterRound1++;
                                counterRound3++;
                                TestRound testRound = new TestRound();
                                testRound.TestingRound = "Round 3";
                                testRound.A2Q2Samples = counterRound1.ToString();
                                testRound.Status = "Open";

                                //System.Diagnostics.Debug.WriteLine($"retData[retData.Count - 2] : {retData[retData.Count - 2]}");

                                //Display base on selected option
                                if (indexSelectedHeaderR3[0] >= 0)
                                {

                                    testRound.HeaderRoundDisplay1 = sampleSelection.DisplayHeaderR31;
                                    testRound.ContentDisplay1 = (retData[indexSelectedHeaderR3[0]] != null ? retData[indexSelectedHeaderR3[0]] : string.Empty);
                                    System.Diagnostics.Debug.WriteLine($"GenerateRound 3: indexSelectedHeaderR3[0]={indexSelectedHeaderR3[0]} | HeaderRoundDisplay1={sampleSelection.DisplayHeaderR31}");
                                    //checkTestRoundExists = sampleSelection.ListTestRound.Where(x => !x.ContentDisplay1.Equals(retData[indexSelectedHeaderR3[0]])).FirstOrDefault();

                                }

                                if (indexSelectedHeaderR3[1] >= 0)
                                {
                                    testRound.HeaderRoundDisplay2 = sampleSelection.DisplayHeaderR32;
                                    testRound.ContentDisplay2 = (retData[indexSelectedHeaderR3[1]] != null ? retData[indexSelectedHeaderR3[1]] : string.Empty);
                                    System.Diagnostics.Debug.WriteLine($"GenerateRound 3: indexSelectedHeaderR3[1]={indexSelectedHeaderR3[1]} | HeaderRoundDisplay2={sampleSelection.DisplayHeaderR32}");
                                }

                                if (indexSelectedHeaderR3[2] >= 0)
                                {
                                    testRound.HeaderRoundDisplay3 = sampleSelection.DisplayHeaderR33;
                                    testRound.ContentDisplay3 = (retData[indexSelectedHeaderR3[2]] != null ? retData[indexSelectedHeaderR3[2]] : string.Empty);
                                    System.Diagnostics.Debug.WriteLine($"GenerateRound 3: indexSelectedHeaderR3[2]={indexSelectedHeaderR3[2]} | HeaderRoundDisplay3={sampleSelection.DisplayHeaderR33}");
                                }

                                if (indexSelectedHeaderR3[3] >= 0)
                                {
                                    testRound.HeaderRoundDisplay4 = sampleSelection.DisplayHeaderR34;
                                    testRound.ContentDisplay4 = (retData[indexSelectedHeaderR3[3]] != null ? retData[indexSelectedHeaderR3[3]] : string.Empty);
                                    System.Diagnostics.Debug.WriteLine($"GenerateRound 3: indexSelectedHeaderR3[3]={indexSelectedHeaderR3[3]} | HeaderRoundDisplay4={sampleSelection.DisplayHeaderR34}");
                                }

                                if (indexSelectedHeaderR3[4] >= 0)
                                {
                                    testRound.HeaderRoundDisplay5 = sampleSelection.DisplayHeaderR35;
                                    testRound.ContentDisplay5 = (retData[indexSelectedHeaderR3[4]] != null ? retData[indexSelectedHeaderR3[4]] : string.Empty);
                                    System.Diagnostics.Debug.WriteLine($"GenerateRound 3: indexSelectedHeaderR3[4]={indexSelectedHeaderR3[4]} | HeaderRoundDisplay5={sampleSelection.DisplayHeaderR35}");
                                }

                                if (isSpecificRow && testRound.ContentDisplay1 != null && testRound.ContentDisplay1 != string.Empty)
                                {
                                    var checkTestRoundExists = sampleSelection.ListTestRound.Where(x => x.ContentDisplay1.Equals(testRound.ContentDisplay1)).FirstOrDefault();
                                    if (checkTestRoundExists == null) //check if it exists in list of test round
                                    {
                                        var updateList = sampleSelection.ListTestRound.FirstOrDefault(x => x.A2Q2Samples.Equals(index.ToString()));
                                        if (updateList != null)
                                        {
                                            updateList.Date = testRound.Date;
                                            updateList.MonthOnly = testRound.MonthOnly;
                                            updateList.WeeklyOnly = testRound.WeeklyOnly;
                                            updateList.HeaderRoundDisplay1 = testRound.HeaderRoundDisplay1;
                                            updateList.ContentDisplay1 = testRound.ContentDisplay1;
                                            updateList.HeaderRoundDisplay2 = testRound.HeaderRoundDisplay2;
                                            updateList.ContentDisplay2 = testRound.ContentDisplay2;
                                            updateList.HeaderRoundDisplay3 = testRound.HeaderRoundDisplay3;
                                            updateList.ContentDisplay3 = testRound.ContentDisplay3;
                                            updateList.HeaderRoundDisplay4 = testRound.HeaderRoundDisplay4;
                                            updateList.ContentDisplay4 = testRound.ContentDisplay4;
                                            updateList.HeaderRoundDisplay5 = testRound.HeaderRoundDisplay5;
                                            updateList.ContentDisplay5 = testRound.ContentDisplay5;
                                            break;
                                        }
                                    }
                                }
                                else
                                {
                                    sampleSelection.ListTestRound.Add(testRound);
                                    tempUnique.Add(retData[retData.Count - 2]);
                                }
                                System.Diagnostics.Debug.WriteLine($"Counter {counterRound3}: {sampleSelection.SamplesByRound3}");
                            }
                            else
                            {
                                System.Diagnostics.Debug.WriteLine($"Temp Unique Exists Round 3: {retData[retData.Count - 2]}");
                            }
                        }

                    }
                    else
                    {
                        //we only get the first row in the list of unique content
                        //var rawData = tempListUniqueContent3.Take(sampleSelection.SamplesByRound3);



                        if (isSpecificRow)
                        {
                            tempListUniqueContent3.RemoveAt(index);
                            counterRound3 = 0;
                        }


                        rawData = tempListUniqueContent3;


                        foreach (var retData in rawData)
                        {
                            if (counterRound3 != sampleSelection.SamplesByRound3)
                            {
                                retData.FirstOrDefault();
                                if (!tempUnique.Contains(retData[retData.Count - 2]))
                                {
                                    counterRound1++;
                                    counterRound3++;
                                    TestRound testRound = new TestRound();
                                    testRound.TestingRound = "Round 3";
                                    testRound.A2Q2Samples = counterRound1.ToString();
                                    testRound.Status = "Open";

                                    //Display base on selected option
                                    if (indexSelectedHeaderR3[0] >= 0)
                                    {
                                        testRound.HeaderRoundDisplay1 = sampleSelection.DisplayHeaderR31;
                                        testRound.ContentDisplay1 = (retData[indexSelectedHeaderR3[0]] != null ? retData[indexSelectedHeaderR3[0]] : string.Empty);
                                        System.Diagnostics.Debug.WriteLine($"GenerateRound 2: indexSelectedHeaderR3={indexSelectedHeaderR3[0]}");
                                    }

                                    if (indexSelectedHeaderR3[1] >= 0)
                                    {
                                        testRound.HeaderRoundDisplay2 = sampleSelection.DisplayHeaderR32;
                                        testRound.ContentDisplay2 = (retData[indexSelectedHeaderR3[1]] != null ? retData[indexSelectedHeaderR3[1]] : string.Empty);
                                        System.Diagnostics.Debug.WriteLine($"GenerateRound 3: indexSelectedHeaderR3={indexSelectedHeaderR3[1]}");
                                    }

                                    if (indexSelectedHeaderR3[2] >= 0)
                                    {
                                        testRound.HeaderRoundDisplay3 = sampleSelection.DisplayHeaderR33;
                                        testRound.ContentDisplay3 = (retData[indexSelectedHeaderR3[2]] != null ? retData[indexSelectedHeaderR3[2]] : string.Empty);
                                        System.Diagnostics.Debug.WriteLine($"GenerateRound 3: indexSelectedHeaderR3={indexSelectedHeaderR3[2]}");
                                    }

                                    if (indexSelectedHeaderR3[3] >= 0)
                                    {
                                        testRound.HeaderRoundDisplay4 = sampleSelection.DisplayHeaderR34;
                                        testRound.ContentDisplay4 = (retData[indexSelectedHeaderR3[3]] != null ? retData[indexSelectedHeaderR3[3]] : string.Empty);
                                        System.Diagnostics.Debug.WriteLine($"GenerateRound 3: indexSelectedHeaderR3={indexSelectedHeaderR3[3]}");
                                    }

                                    if (indexSelectedHeaderR3[4] >= 0)
                                    {
                                        testRound.HeaderRoundDisplay5 = sampleSelection.DisplayHeaderR35;
                                        testRound.ContentDisplay5 = (retData[indexSelectedHeaderR3[4]] != null ? retData[indexSelectedHeaderR3[4]] : string.Empty);
                                        System.Diagnostics.Debug.WriteLine($"GenerateRound 3: indexSelectedHeaderR3={indexSelectedHeaderR3[4]}");
                                    }


                                    if (isSpecificRow && testRound.ContentDisplay1 != null && testRound.ContentDisplay1 != string.Empty)
                                    {
                                        var checkTestRoundExists = sampleSelection.ListTestRound.Where(x => x.ContentDisplay1.Equals(testRound.ContentDisplay1)).FirstOrDefault();
                                        if (checkTestRoundExists == null) //check if it exists in list of test round
                                        {
                                            var updateList = sampleSelection.ListTestRound.FirstOrDefault(x => x.A2Q2Samples.Equals(index.ToString()));
                                            if (updateList != null)
                                            {
                                                updateList.Date = testRound.Date;
                                                updateList.MonthOnly = testRound.MonthOnly;
                                                updateList.WeeklyOnly = testRound.WeeklyOnly;
                                                updateList.HeaderRoundDisplay1 = testRound.HeaderRoundDisplay1;
                                                updateList.ContentDisplay1 = testRound.ContentDisplay1;
                                                updateList.HeaderRoundDisplay2 = testRound.HeaderRoundDisplay2;
                                                updateList.ContentDisplay2 = testRound.ContentDisplay2;
                                                updateList.HeaderRoundDisplay3 = testRound.HeaderRoundDisplay3;
                                                updateList.ContentDisplay3 = testRound.ContentDisplay3;
                                                updateList.HeaderRoundDisplay4 = testRound.HeaderRoundDisplay4;
                                                updateList.ContentDisplay4 = testRound.ContentDisplay4;
                                                updateList.HeaderRoundDisplay5 = testRound.HeaderRoundDisplay5;
                                                updateList.ContentDisplay5 = testRound.ContentDisplay5;
                                                break;
                                            }
                                        }
                                    }
                                    else
                                    {
                                        sampleSelection.ListTestRound.Add(testRound);
                                        tempUnique.Add(retData[retData.Count - 2]);
                                    }

                                    System.Diagnostics.Debug.WriteLine($"Counter {counterRound3}: {sampleSelection.SamplesByRound2}");

                                    //if (tempListUniqueContent1.Count > 0)
                                    //    tempListUniqueContent1.RemoveAt(0);
                                }
                                else
                                {
                                    System.Diagnostics.Debug.WriteLine($"Temp Unique Exists Round 2: {retData[retData.Count - 2]}");
                                }
                            }
                            else
                            {
                                break;
                            }
                        }


                    }

                }

                isGenerated = true;
                #endregion

            }
            else
            {
                toastService.ShowError($"An error occurred in Generating Round 3");
            }

            SortTestRound();
            this.StateHasChanged();
        }


    }

    private void NewData()
    {
        JSRuntime.InvokeAsync<object>("SampleSelectionReset");
        sampleSelection = new SampleSelection();
        sampleSelection.ListRefId = new List<TestRoundSampleSelectionReference>();
        sampleSelection.ListTestRound = new List<TestRound>();

        randomValue = string.Empty;
        fileName = string.Empty;
        isGenerated = false;

        indexConsiderMat = new int[] { -1, -1, -1 };
        indexSelectedHeaderR1 = new int[] { -1, -1, -1, -1, -1 };
        indexSelectedHeaderR2 = new int[] { -1, -1, -1, -1, -1 };
        indexSelectedHeaderR3 = new int[] { -1, -1, -1, -1, -1 };

        StartDate1 = null;
        StartDate2 = null;
        StartDate3 = null;
        EndDate1 = null;
        EndDate2 = null;
        EndDate3 = null;

        listPopulation1 = new List<List<string>>();
        listDropdownPop1 = new List<string>();
        listDropdownPop2 = new List<string>();
        listPopulation2 = new List<List<string>>();
        listDropdownPop3 = new List<string>();
        listPopulation3 = new List<List<string>>();

        isDisableMateriality = true;
        activeMateriality = 0;

        this.StateHasChanged();
    }

    private void ResetTM()
    {
        JSRuntime.InvokeAsync<object>("SampleSelectionResetFile");
        indexConsiderMat = new int[] { -1, -1, -1 };
        indexSelectedHeaderR1 = new int[] { -1, -1, -1, -1, -1 };
        indexSelectedHeaderR2 = new int[] { -1, -1, -1, -1, -1 };
        indexSelectedHeaderR3 = new int[] { -1, -1, -1, -1, -1 };
        listPopulation1 = new List<List<string>>();
        listDropdownPop1 = new List<string>();
        listDropdownPop2 = new List<string>();
        listPopulation2 = new List<List<string>>();
        listDropdownPop3 = new List<string>();
        listPopulation3 = new List<List<string>>();
        activeMateriality = 0;
        //sampleSelection.IsMateriality = string.Empty;
        //isDisableMateriality = true;
        //activeMateriality = 0;

    }

    //sort test round list
    private void SortTestRound()
    {
        if (sampleSelection.ListTestRound.Count > 0)
        {
            sampleSelection.ListTestRound = sampleSelection.ListTestRound.OrderBy(x => x.TestingRound).ToList();
            sampleSelection.PopulationByRoundTot = sampleSelection.PopulationByRound1
                + sampleSelection.PopulationByRound2
                + sampleSelection.PopulationByRound3;
            sampleSelection.SamplesByRoundTot = sampleSelection.SamplesByRound1
               + sampleSelection.SamplesByRound2
               + sampleSelection.SamplesByRound3;
            System.Diagnostics.Debug.WriteLine($"Test Round List Sorted: true");
        }
    }

    private void DownloadExcelFile()
    {

        try
        {
            if (fileName != string.Empty)
            {
                //ClientSettings settings = new ClientSettings();
                JSRuntime.InvokeAsync<object>("DownloadFile", $"SampleSelection/download/" + fileName);
            }
        }
        catch (Exception ex)
        {
            randomValue = ex.ToString();
            //throw;
        }

    }

    private string DownloadExcelFile2(string fileName)
    {
        return $"{NavigationManager.BaseUri}api/SampleSelection/download/{fileName}";
    }

    //this function will create excel file and save data in podio
    private async void SaveData()
    {

        if (sampleSelection.PodioItemId == 0)
        {

            //WriteLog writeLog = new WriteLog();
            //writeLog.Display(sampleSelection);

            randomValue = "Creating Excel";
            sampleSelection.Version = version;

            #region Create Excel
            //create excel file and set download link
            var excelResponse = await SelectionService.CreateExcelAsync(sampleSelection, Http);
            //var excelResponse = await SelectionService.SampleSelectionTest(sampleSelection);

            //System.Diagnostics.Debug.WriteLine($"------------------------------------------------------");
            //var jsonData = Newtonsoft.Json.JsonConvert.SerializeObject(sampleSelection);
            //System.Diagnostics.Debug.WriteLine(jsonData);
            //System.Diagnostics.Debug.WriteLine($"------------------------------------------------------");

            if (excelResponse.StatusCode.ToString() == "OK")
            {
                fileName = excelResponse.Content.ReadAsStringAsync().Result.ToString();
                randomValue = fileName;

            }
            else
            {
                randomValue = "Failed to create excel output";
                toastService.ShowError("Failed to create excel output");
            }

            //manually refresh UI
            this.StateHasChanged();
            #endregion

            #region Podio Save
            //Create podio test round
            var podioRoundResponse = await SelectionService.CreatePodioTestRoundAsync(sampleSelection, Http);
            if (podioRoundResponse.StatusCode.ToString() == "OK")
            {
                //fileName = excelResponse.Content.ReadAsStringAsync().Result.ToString();
                //randomValue = fileName;
                string result = podioRoundResponse.Content.ReadAsStringAsync().Result.ToString();
                sampleSelection.ListTestRound = JsonConvert.DeserializeObject<List<TestRound>>(result);

                StringBuilder createdItemId = new StringBuilder();
                foreach (var item in sampleSelection.ListTestRound)
                {
                    createdItemId.Append($"{item.PodioItemId},");
                    //sampleSelection.ListTestRound
                    //    .Where(x => x.PodioItemId == 0 && x.A2Q2Samples == item)
                    //    .Select(i => { i.PodioItemId = item.PodioItemID; return i; })
                    //    .FirstOrDefault();
                }

                randomValue = $"Testing Rounds Id: {createdItemId.ToString()}";

                //manually refresh UI
                this.StateHasChanged();

                if (sampleSelection.ListTestRound != null)
                {
                    //Crete podio sample selection and add test round as reference app
                    var podioSampleResponse = await SelectionService.CreatePodioSampleSelectionAsync(sampleSelection, Http);
                    if (podioSampleResponse.StatusCode.ToString() == "OK")
                    {
                        List<string> itemId = JsonConvert.DeserializeObject<List<string>>(podioSampleResponse.Content.ReadAsStringAsync().Result.ToString());
                        randomValue = "Sample Selection Id: " + string.Join(",", itemId.ToArray());
                        int.TryParse(itemId.FirstOrDefault(), out int sampleSelectionItemId);
                        sampleSelection.PodioItemId = sampleSelectionItemId;

                        #region Database Save
                        //Save to databse
                        if (sampleSelection.PodioItemId > 0)
                        {
                            var dataResponse = await SelectionService.SaveSampleSelectionAsync(sampleSelection, Http);
                            if (dataResponse.StatusCode.ToString() == "OK")
                            {
                                toastService.ShowSuccess("Successfully save to database");

                            }
                            else
                            {
                                toastService.ShowError("Failed saving to database");

                            }
                        }

                        //randomValue = Newtonsoft.Json.JsonConvert.SerializeObject(sampleSelection);
                        //manually refresh UI
                        this.StateHasChanged();
                        #endregion

                    }
                    else
                    {
                        //randomValue = "Failed to create podio sample selection";
                        randomValue = Newtonsoft.Json.JsonConvert.SerializeObject(sampleSelection);
                    }
                    //manually refresh UI
                    this.StateHasChanged();

                }

            }
            else
            {
                randomValue = "Failed to create podio test rounds";
                toastService.ShowError("Failed to create podio test rounds");
            }
            //manually refresh UI
            this.StateHasChanged();
            #endregion

        }
        else
        {
            toastService.ShowInfo($"Sample selection is already save, please create new sample selection");
        }

    }

    private void BackToQuestionnaire()
    {
        NavigationManager.NavigateTo($"questionnairegenerate/{sampleSelection.RcmPodioItemId}/{sampleSelection.PodioItemId}/{testingPhase}");
    }

    /// <summary> Get working days between two dates (Excluding a list of dates - Holidays) </summary>
    /// <param name="startD">Current date time</param>
    /// <param name="endD">Finish date time</param>
    private double GetWorkingDays(DateTime startD, DateTime endD)
    {
        double calcBusinessDays =
        1 + ((endD - startD).TotalDays * 5 -
        (startD.DayOfWeek - endD.DayOfWeek) * 2) / 7;

        if (endD.DayOfWeek == DayOfWeek.Saturday) calcBusinessDays--;
        if (startD.DayOfWeek == DayOfWeek.Sunday) calcBusinessDays--;

        return calcBusinessDays;
    }

    private decimal Mod(decimal number, decimal divisor)
    {
        //= number - (INT(number / divisor) * divisor)
        return (number - ((int)(number / divisor) * divisor));
    }

    private IOrderedEnumerable<List<string>> SortListDesc(List<List<string>> listContent, int index)
    {
        IOrderedEnumerable<List<string>> listSortedContent;

        List<string> number = new List<string>();


        //listSortedContent = listContent.OrderByDescending(x => x[index]);
        int maxlen = listContent.Max(x => x[index].Length);
        System.Diagnostics.Debug.WriteLine($"MaxLen = {maxlen}");
        listSortedContent = listContent.OrderByDescending(x => x[index].PadLeft(maxlen, '0')).ThenBy(c => c[index]);

        //listSortedContent = listSortedContent.OrderByDescending(x => x[index].PadLeft(maxlen, '0'));

        //Console.WriteLine($"====================AFTER====================");
        //row = 0;
        //foreach (var item in listSortedContent)
        //{
        //    column = 0;
        //    StringBuilder sb;
        //    foreach (var innerItem in item)
        //    {
        //        sb = new StringBuilder();
        //        if (column == 14)
        //        {
        //            sb.Append(innerItem + " | ");
        //        }
        //        else if (column == 27)
        //        {
        //            sb.Append(innerItem);
        //            Console.WriteLine($"{sb.ToString()}");
        //        }
        //        column++;
        //    }
        //    row++;
        //}

        return listSortedContent;


    }

    private IOrderedEnumerable<List<string>> SortListDesc2(List<List<string>> listContent, int index)
    {
        IOrderedEnumerable<List<string>> listSortedContent;

        //listSortedContent = listContent.OrderByDescending(x => x[index]);
        int maxlen = listContent.Max(x => x[index].Length);
        System.Diagnostics.Debug.WriteLine($"MaxLen = {maxlen}");
        listSortedContent = listContent.OrderByDescending(x => x[index].PadLeft(maxlen, '0')).ThenBy(c => c[index]);


        System.Diagnostics.Debug.WriteLine($"====================AFTER====================");
        //int row = 0;
        foreach (var item in listSortedContent)
        {

            System.Diagnostics.Debug.WriteLine($"[{item[27]}] : {item[12]}");

            //int column = 0;
            //StringBuilder sb = new StringBuilder();
            //foreach (var innerItem in item)
            //{
            //    if (column == 14)
            //    {
            //        sb.Append($"{innerItem} |");
            //    }
            //    else if (column == 27)
            //    {
            //        sb.Append($"{innerItem}");
            //    }
            //    column++;
            //}
            //Console.WriteLine($"{sb.ToString()}");
            //row++;
        }

        return listSortedContent;


    }

    private void ReturnRegenData(RegenerateData generate)
    {
        if (generate != null) //verify if not null
        {
            //regenerate all data
            if (generate.IsAll)
            {
                ComputeRound(false, 0);
            }
            //regenerate specific index
            else
            {
                ComputeRound(true, generate.Index);
            }
        }
    }

    private void GetDate(DateRangeSelected dtSelected, int round)
    {
        if (dtSelected != null)
        {
            switch (round)
            {
                case 1:

                    if (dtSelected.startDate.HasValue)
                    {
                        StartDate1 = dtSelected.startDate.Value;
                        sampleSelection.Round1Start = dtSelected.startDate.Value;
                    }

                    if (dtSelected.endDate.HasValue)
                    {
                        EndDate1 = dtSelected.endDate.Value;
                        sampleSelection.Round1End = dtSelected.endDate.Value;
                    }

                    if(sampleSelection.Round1Start != null && sampleSelection.Round1End != null)
                    {
                        roundSelected = 1;
                        ComputeRound(false, 0);
                    }
                    break;
                case 2:
                    if (dtSelected.startDate.HasValue)
                    {
                        StartDate2 = dtSelected.startDate.Value;
                        sampleSelection.Round2Start = dtSelected.startDate.Value;
                    }

                    if (dtSelected.endDate.HasValue)
                    {
                        EndDate2 = dtSelected.endDate.Value;
                        sampleSelection.Round2End = dtSelected.endDate.Value;
                    }

                    if (sampleSelection.Round2Start != null && sampleSelection.Round2End != null)
                    {
                        roundSelected = 2;
                        ComputeRound(false, 0);
                    }
                    break;
                case 3:
                    if (dtSelected.startDate.HasValue)
                    {
                        StartDate3 = dtSelected.startDate.Value;
                        sampleSelection.Round3Start = dtSelected.startDate.Value;
                    }

                    if (dtSelected.endDate.HasValue)
                    {
                        EndDate3 = dtSelected.endDate.Value;
                        sampleSelection.Round3End = dtSelected.endDate.Value;
                    }

                    if (sampleSelection.Round3Start != null && sampleSelection.Round3End != null)
                    {
                        roundSelected = 3;
                        ComputeRound(false, 0);
                    }
                    break;
            }
            System.Diagnostics.Debug.WriteLine($"Return Start Date: {dtSelected.startDate.Value.ToString()}");
            System.Diagnostics.Debug.WriteLine($"Return End Date: {dtSelected.endDate.Value.ToString()}");
        }

        this.StateHasChanged();
    }

}
